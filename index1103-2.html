<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (v6.2 ä¿®æ­£) ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–° -->
    <title>å°å­¦2å¹´ç”Ÿå‘ã‘ è‹±èªæ–‡æ³•ã‚ãã³ v6.2</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 3. Babel (JSXã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤‰æ›ã™ã‚‹) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Interãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ï¼ˆTailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        /* æ­£è§£æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes flash-correct {
            0% { background-color: rgba(255,255,255,0.9); }
            50% { background-color: rgba(209, 250, 229, 0.9); } /* emerald-100/90 */
            100% { background-color: rgba(255,255,255,0.9); }
        }
        .animate-flash-correct {
            animation: flash-correct 0.6s ease-in-out;
        }
        /* ã‚¬ãƒãƒ£çµæœç”¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes jump-in {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-jump-in {
            animation: jump-in 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 4. Reactã‚¢ãƒ—ãƒªãŒæç”»ã•ã‚Œã‚‹å ´æ‰€ -->
    <div id="root"></div>

    <!-- 5. Reactã‚¢ãƒ—ãƒªã®ã‚³ãƒ¼ãƒ‰ (type="text/babel" ã«æ³¨æ„) -->
    <script type="text/babel">
// ------------------------------
// å°å­¦2å¹´ç”Ÿå‘ã‘ è‹±èªæ–‡æ³•ã‚ãã³ã‚¢ãƒ—ãƒªï¼ˆæ”¹å–„ç‰ˆ v6.2ï¼‰
//
// v6.1ã‹ã‚‰ã®ä¸»ãªå¤‰æ›´ç‚¹ï¼š
// 1. (v6.2 ä¿®æ­£1) å‰ç½®è©ã‚„ä»–ã®é¸æŠå•é¡Œã§ã€é¸æŠè‚¢ãŒæ­£ã—ã4æŠã«ãªã‚‰ãªã„ãƒã‚°ã‚’ä¿®æ­£
//    (ensureFourChoices ãŒäºŒé‡ã«å‘¼ã°ã‚Œã¦ã„ãŸå•é¡Œã‚’è§£æ¶ˆ)
// 2. (v6.2 ä¿®æ­£2) ç§°å·ã®åå‰ã‚’å¤‰æ›´ (10000pt, 20000pt)
// 3. (v6.2 ä¿®æ­£3) ãƒ–ã‚¶ãƒ¼éŸ³ã‚’å‰Šé™¤ (playBuzzer é–¢æ•°ã¨é–¢é€£å‘¼ã³å‡ºã—ã‚’å‰Šé™¤)
// 4. (v6.2 ä¿®æ­£4) ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã‚’50ç¨® -> 100ç¨® ã«å€å¢—
// 5. (v6.2 ä¿®æ­£5) ã‚¬ãƒãƒ£ãŒå¼•ã‘ã‚‹æ™‚(gachaPulls > 0)ã«å•é¡Œã‚«ãƒ¼ãƒ‰å†…ã«ã‚µã‚¤ãƒ³ã‚’è¡¨ç¤º
//
// v6.0ã‹ã‚‰ã®ä¸»ãªå¤‰æ›´ç‚¹ï¼š
// (v6.0 ä¿®æ­£1: v5.xã§ã®åº¦é‡ãªã‚‹ä¿®æ­£ã§å¤±ã‚ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ãƒ»å®šæ•°ã‚’ v5.10 ç›¸å½“ã‹ã‚‰å†ãƒãƒ¼ã‚¸)
// (v6.0 ä¿®æ­£2: ã‚¬ãƒãƒ£ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ v5.10 ç›¸å½“ã‹ã‚‰å†ãƒãƒ¼ã‚¸)
// (v6.0 ä¿®æ­£3: ãƒ¬ãƒƒã‚¹ãƒ³åˆ¥ç§°å·ã®å®šç¾©ãƒ»é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ã‚’ v5.10 ç›¸å½“ã‹ã‚‰å†ãƒãƒ¼ã‚¸)
// (v6.1 ä¿®æ­£1: v6.0ã®ä¿®æ­£æ¼ã‚Œï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ã‚„ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼‰ã‚’ v5.10 ã‹ã‚‰å†ãƒãƒ¼ã‚¸)
// ------------------------------
// (v5.5 ä¿®æ­£1: ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ãŸReactãƒ•ãƒƒã‚¯ã®å®šç¾©ã‚’å…ƒã«æˆ»ã™)
const { useEffect, useMemo, useRef, useState, useCallback } = React;

// âœ… ãµã‚ŠãŒãªï¼ˆ<ruby>ã‚¿ã‚°ã‚’ä½¿ç”¨ï¼‰
// (v5.6 ä¿®æ­£1: å£Šã‚Œã¦ã„ãŸé–¢æ•°ã‚’ä¿®æ­£)
function F({ rb, rt }) {
  return (
    <ruby className="[ruby-position:over]">
      <span>{rb}</span>
      <rt className="text-xs text-gray-600">{rt}</rt>
    </ruby>
  );
}

// (v5.6 ä¿®æ­£1: å£Šã‚Œã¦ã„ãŸç§°å·ãƒªã‚¹ãƒˆã®å®šç¾©ã‚’ä¿®æ­£)
const GLOBAL_TITLES = [
  { id: "start", name: "ã¯ã˜ã‚ã®ä¸€æ­©", emoji: 'ğŸŒŸ', desc: "åˆè¨ˆ5å•æ­£è§£ã§ç²å¾—" },
  { id: "streak5", name: "é€£ç¶šã‚­ãƒ³ã‚°", emoji: 'ğŸ‘‘', desc: "5é€£ç¶šæ­£è§£ã§ç²å¾—" },
  { id: "owlGuide", name: "ãƒ•ã‚¯ãƒ­ã‚¦å…ˆç”Ÿ", emoji: 'ğŸ¦‰', desc: "beå‹•è©ãƒ¬ãƒƒã‚¹ãƒ³ã§5å•æ­£è§£" },
  { id: "morningMaster", name: "æœæ´»ãƒã‚¹ã‚¿ãƒ¼", emoji: 'â˜€ï¸', desc: "åˆå‰5æ™‚ï½10æ™‚ã«ãƒ—ãƒ¬ã‚¤ã—ã¦ç²å¾—" },
  { id: "coin1000", name: "ãƒã‚¤ãƒ³ãƒˆ1000ç²å¾—", emoji: 'ğŸ’', desc: "åˆè¨ˆ1000ãƒã‚¤ãƒ³ãƒˆç²å¾—" },
  { id: "explorer", name: "ãƒ¬ãƒƒã‚¹ãƒ³æ¢æ¤œå®¶", emoji: 'ğŸ§­', desc: "4ç¨®é¡ä»¥ä¸Šã®ãƒ¬ãƒƒã‚¹ãƒ³ã§æ­£è§£" },
  { id: "lionHero", name: "ãƒ©ã‚¤ã‚ªãƒ³ã®å‹‡è€…", emoji: 'ğŸ¦', desc: "åˆè¨ˆ5000ãƒã‚¤ãƒ³ãƒˆã§ç²å¾—" },
  // (v6.2 ä¿®æ­£2: ç§°å·ã®åå‰ã‚’å¤‰æ›´)
  { id: "coin10000", name: "ã‚´ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼", emoji: 'ğŸ’°', desc: "åˆè¨ˆ10000ãƒã‚¤ãƒ³ãƒˆç²å¾—" },
  { id: "coin20000", name: "ãƒ—ãƒ©ãƒãƒŠã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼", emoji: 'ğŸ¦', desc: "åˆè¨ˆ20000ãƒã‚¤ãƒ³ãƒˆç²å¾—" },
];
const TITLE_PERKS = {
  start: { headerBadge: "ã¯ã˜ã‚ã®ä¸€æ­©", headerClass: "border-b-4 border-amber-300" },
  streak5: { headerBadge: "é€£ç¶šã‚­ãƒ³ã‚°" },
  owlGuide: { headerBadge: "ãƒ•ã‚¯ãƒ­ã‚¦å…ˆç”Ÿ", beHint: true },
  morningMaster: { headerBadge: "æœæ´»ãƒã‚¹ã‚¿ãƒ¼", headerClass: "border-2 border-yellow-300" },
  coin1000: { headerBadge: "ãƒã‚¤ãƒ³ãƒˆ1000ç²å¾—" },
  explorer: { headerBadge: "ãƒ¬ãƒƒã‚¹ãƒ³æ¢æ¤œå®¶" },
  lionHero: { headerBadge: "ãƒ©ã‚¤ã‚ªãƒ³ã®å‹‡è€…", headerClass: "border-4 border-orange-400" },
  // (v6.2 ä¿®æ­£2: ç§°å·ã®åå‰ã‚’å¤‰æ›´)
  coin10000: { headerBadge: "ã‚´ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼" },
  coin20000: { headerBadge: "ãƒ—ãƒ©ãƒãƒŠã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼" },
};
const LESSON_TITLES = [
    { id: 'correct10', name: 'ãƒ–ãƒ­ãƒ³ã‚º', emoji: 'ğŸ¥‰', condition: (s) => s.correct >= 10, desc: "åˆè¨ˆ10å•æ­£è§£" },
    { id: 'streak10', name: 'ã‚·ãƒ«ãƒãƒ¼', emoji: 'ğŸ¥ˆ', condition: (s) => s.streakMax >= 10, desc: "10å•é€£ç¶šæ­£è§£" },
    { id: 'streak20', name: 'ã‚´ãƒ¼ãƒ«ãƒ‰', emoji: 'ğŸ¥‡', condition: (s) => s.streakMax >= 20, desc: "20å•é€£ç¶šæ­£è§£" },
    { id: 'platinum', name: 'ãƒ—ãƒ©ãƒãƒŠ', emoji: 'ğŸ’', condition: (s) => (s.correct * 5) >= 100, desc: "100ãƒ¬ãƒƒã‚¹ãƒ³Ptç²å¾—" },
    { id: 'master', name: 'ãƒã‚¹ã‚¿ãƒ¼', emoji: 'ğŸ†', condition: (s) => ['correct10', 'streak10', 'streak20', 'platinum'].every(t => s.titles.includes(t)), desc: "ä¸Šè¨˜4ã¤ã®ç§°å·ã‚’ã™ã¹ã¦ç²å¾—" },
];
const LESSON_TITLE_PERKS = {
    correct10: { border: 'border-2 border-amber-700/50' },
    streak10: { border: 'border-2 border-slate-400/80' },
    streak20: { border: '[3px] border-amber-400 shadow-[0_0_0_3px_rgba(251,191,36,0.2)]' },
    platinum: { border: '[3px] border-sky-400 ring-2 ring-sky-300', bg: 'bg-gradient-to-br from-sky-50/50 to-white' },
    master: { border: '[3px] border-purple-500 shadow-[0_0_0_3px_rgba(168,85,247,0.3)]', bg: 'bg-gradient-to-br from-purple-100/50 to-indigo-100/50' },
};
const getLessonCardClass = (base, titles) => {
    let perk = {};
    if (titles.includes('master')) perk = LESSON_TITLE_PERKS.master;
    else if (titles.includes('platinum')) perk = LESSON_TITLE_PERKS.platinum;
    else if (titles.includes('streak20')) perk = LESSON_TITLE_PERKS.streak20;
    else if (titles.includes('streak10')) perk = LESSON_TITLE_PERKS.streak10;
    else if (titles.includes('correct10')) perk = LESSON_TITLE_PERKS.correct10;
    return `${base} ${perk.border || 'border border-gray-200'} ${perk.bg || ''}`;
};

const speakEn = (text) => {
  try {
    if (typeof window === "undefined" || !window.speechSynthesis) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 0.7;
    u.pitch = 1.0;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  } catch {}
};

// (v6.2 ä¿®æ­£3: ãƒ–ã‚¶ãƒ¼éŸ³ã‚’å‰Šé™¤)
// const playBuzzer = () => { ... };

// (v5.7 ä¿®æ­£1: æœªå®šç¾©ã ã£ãŸ 'getTodayString' ã‚’è¿½åŠ )
const getTodayString = () => {
  const d = new Date();
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0'); // 0-indexed
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// (v6.1 ä¿®æ­£1: v5.5ä»¥é™ã®ä¿®æ­£ã§å¤±ã‚ã‚Œã¦ã„ãŸã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ã¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’å†è¿½åŠ )
// ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ãƒ»ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° =====
const LS_KEY = "eigoAppS2_v5"; // v5.1ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ å¤‰æ›´

const ALL_SUBJECTS = ["I", "You", "He", "She", "Taro", "Hanako", "We", "They"];
// (v5.3 ä¿®æ­£1: 'He' ãªã©ã‚’å°æ–‡å­—ã«ã—ã¦ã„ãŸãŒã€æ–‡é ­ã«æ¥ã‚‹ãŸã‚å¤§æ–‡å­—ã«æˆ»ã™ã€‚be-questionå´ã§å°æ–‡å­—ã‚’ä½¿ã†ã‚ˆã†ã«ã™ã‚‹)
const ALL_SINGULAR_SUBJECTS = ["He", "She", "Taro", "Hanako"];
// (v5.3 ä¿®æ­£1: be-questionç”¨ã®ä¸»èªãƒªã‚¹ãƒˆã€‚'I' ã‚„ 'we' ã‚’å«ã‚€)
const BE_Q_SUBJECTS = ["I", "you", "he", "she", "Taro", "Hanako", "we", "they"];
// (v5.3 ä¿®æ­£1: ä¿®æ­£ã«ã‚ãŸã‚Š 'I', 'We' ã‚’å‰Šé™¤)
const ALL_Q_SUBJECTS = ["you", "he", "she", "Taro", "Hanako", "they"]; // Do/Does/Did ã®ç–‘å•æ–‡ã§ä½¿ã†ä¸»èª

const getJPSubj = (s) => ({ "I": <><F rb="ã‚ãŸã—" rt="ã‚ãŸã—"/>ã¯</>, "You": <><F rb="ã‚ãªãŸ" rt="ã‚ãªãŸ"/>ã¯</>, "He": <><F rb="å½¼" rt="ã‹ã‚Œ"/>ã¯</>, "She": <><F rb="å½¼å¥³" rt="ã‹ã®ã˜ã‚‡"/>ã¯</>, "Taro": <>ãŸã‚ã†ãã‚“ã¯</>, "Hanako": <>ã¯ãªã“ã•ã‚“ã¯</>, "We": <><F rb="ã‚ãŸã—ãŸã¡" rt="ã‚ãŸã—"/>ã¯</>, "They": <><F rb="å½¼ã‚‰" rt="ã‹ã‚Œ"/>ã¯</>, "you": <><F rb="ã‚ãªãŸ" rt="ã‚ãªãŸ"/>ã¯</>, "he": <><F rb="å½¼" rt="ã‹ã‚Œ"/>ã¯</>, "she": <><F rb="å½¼å¥³" rt="ã‹ã®ã˜ã‚‡"/>ã¯</>, "they": <><F rb="å½¼ã‚‰" rt="ã‹ã‚Œ"/>ã¯</>, }[s] || <>{s}ã¯</>);
const jpPlace = (p) => ({ "in the box": <><F rb="ç®±" rt="ã¯ã“"/>ã®<F rb="ä¸­" rt="ãªã‹"/>ã«</>, "on the desk": <><F rb="æœº" rt="ã¤ããˆ"/>ã®<F rb="ä¸Š" rt="ã†ãˆ"/>ã«</>, "under the table": <>ãƒ†ãƒ¼ãƒ–ãƒ«ã®<F rb="ä¸‹" rt="ã—ãŸ"/>ã«</>, "next to the chair": <>ã„ã™ã®ã¨ãªã‚Šã«</>, "behind the chair": <>ã„ã™ã®ã†ã—ã‚ã«</>, "near the door": <>ãƒ‰ã‚¢ã®ãã°ã«</>, "in front of the TV": <>ãƒ†ãƒ¬ãƒ“ã®<F rb="å‰" rt="ã¾ãˆ"/>ã«</>, "between the chairs": <>ã„ã™ã®<F rb="é–“" rt="ã‚ã„ã "/>ã«</>, "at home": <><F rb="å®¶" rt="ã„ãˆ"/>ã«</>, "at school": <><F rb="å­¦æ ¡" rt="ãŒã£ã“ã†"/>ã«</>, "in the park": <><F rb="å…¬åœ’" rt="ã“ã†ãˆã‚“"/>ã«</>, "at the library": <><F rb="å›³æ›¸é¤¨" rt="ã¨ã—ã‚‡ã‹ã‚“"/>ã«</>, "under the tree": <><F rb="æœ¨" rt="ã"/>ã®<F rb="ä¸‹" rt="ã—ãŸ"/>ã«</>, }[p] || p);
const jpPlaceNi = (p) => ({ "at home": <><F rb="å®¶" rt="ã„ãˆ"/>ã«</>, "at school": <><F rb="å­¦æ ¡" rt="ãŒã£ã“ã†"/>ã«</>, "in the park": <><F rb="å…¬åœ’" rt="ã“ã†ãˆã‚“"/>ã«</>, "at the library": <><F rb="å›³æ›¸é¤¨" rt="ã¨ã—ã‚‡ã‹ã‚“"/>ã«</>, }[p] || p);
const jpTime = (t) => ({ "yesterday": <><F rb="æ˜¨æ—¥" rt="ãã®ã†"/></>, "last night": <><F rb="æ˜¨å¤œ" rt="ã•ãã‚„"/></>, "this morning": <><F rb="ä»Šæœ" rt="ã‘ã•"/></>, "on Sunday": <><F rb="æ—¥æ›œ" rt="ã«ã¡ã‚ˆã†"/>ã³ã«</>, }[t] || t);
const nounJP = (n) => ({ "apple": <><F rb="ã‚Šã‚“ã”" rt="ã‚Šã‚“ã”"/></>, "egg": <><F rb="ãŸã¾ã”" rt="ãŸã¾ã”"/></>, "orange": <>ã‚ªãƒ¬ãƒ³ã‚¸</>, "umbrella": <><F rb="ã‹ã•" rt="ã‹ã•"/></>, "book": <><F rb="æœ¬" rt="ã»ã‚“"/></>, "bag": <><F rb="ã‹ã°ã‚“" rt="ã‹ã°ã‚“"/></>, "cat": <><F rb="ã­ã“" rt="ã­ã“"/></>, "dog": <><F rb="ã„ã¬" rt="ã„ã¬"/></>, }[n] || n);
// (v5.3 ä¿®æ­£2: è¿½åŠ )
const getPossessive = (s) => ({ "I": "my", "You": "your", "He": "his", "She": "her", "Taro": "his", "Hanako": "her", "We": "our", "They": "their", "you": "your", "he": "his", "she": "her", "they": "their", }[s] || "your");

const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
const shuffle = (arr) => arr.slice().sort(() => Math.random() - 0.5);
const ensureFourChoices = (arr) => {
    let choices = Array.from(new Set(arr)); // é‡è¤‡å‰Šé™¤
    const correct = choices[0];
    let others = choices.slice(1);
    
    // ä¸æ­£è§£ã®é¸æŠè‚¢ãŒ3ã¤æœªæº€ã®å ´åˆã€ä»–ã®é¸æŠè‚¢ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«è¿½åŠ 
    // (ãŸã ã—ã€ã“ã“ã§ã¯å˜ç´”åŒ–ã®ãŸã‚ã€å…ƒã® arr ã«å€™è£œãŒååˆ†ã‚ã‚‹ã¨ä»®å®šã—ã€ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ã¿)
    if (choices.length < 4) {
        // æœ¬æ¥ã¯ãƒ€ãƒŸãƒ¼é¸æŠè‚¢ã®ãƒ—ãƒ¼ãƒ«ã‹ã‚‰æŒã£ã¦ãã‚‹ã¹ãã ãŒã€
        // ç¾çŠ¶ã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ ['correct', 'dummy1', 'dummy2', 'dummy3'] ã®ã‚ˆã†ã«
        // 4ã¤ä»¥ä¸Šæ¸¡ã™ã‹ã€ ['Am', 'Is', 'Are'] ã®ã‚ˆã†ã«æ¸¡ã—ã¦ã„ã‚‹ãŸã‚ã€
        // 4ã¤æœªæº€ã®å ´åˆã¯ãã®ã¾ã¾ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã ã‘ã§ã‚‚æ©Ÿèƒ½ã™ã‚‹ã€‚
        return shuffle(choices);
    }
    
    // æ­£è§£ãŒ1ã¤ã€ä¸æ­£è§£ãŒ3ã¤ä»¥ä¸Šã‚ã‚‹å ´åˆã€ä¸æ­£è§£ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«3ã¤é¸ã¶
    if (others.length >= 3) {
        others = shuffle(others).slice(0, 3);
    }
    
    return shuffle([correct, ...others]);
};
// (v6.1 ä¿®æ­£1 ã“ã“ã¾ã§)


// ===== å•é¡Œç”Ÿæˆé–¢æ•° =====
const prepoScenes = [
    { key: "in", en: "in the box" }, { key: "on", en: "on the desk" },
    { key: "under", en: "under the table" }, { key: "next to", en: "next to the chair" },
    { key: "behind", en: "behind the chair" },
    { key: "near", en: "near the door" },
    { key: "in front of", en: "in front of the TV" },
    { key: "between", en: "between the chairs" },
];
const DID_PAIRS = [
  { v: "play",   tail: "soccer",          jp: (h) => <span>{h}ã‚µãƒƒã‚«ãƒ¼ã‚’ ã—ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "watch", tail: "TV",               jp: (h) => <span>{h}ãƒ†ãƒ¬ãƒ“ã‚’ ã¿ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "eat",   tail: "lunch",           jp: (h) => <span>{h}<F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "go",    tail: "to school",       jp: (h) => <span>{h}<F rb="å­¦æ ¡" rt="ãŒã£ã“ã†" />ã¸ <F rb="è¡Œ" rt="ã„"/>ãã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "read",  tail: "a book",          jp: (h) => <span>{h}<F rb="æœ¬" rt="ã»ã‚“" />ã‚’ <F rb="èª­" rt="ã‚ˆ"/>ã¿ã¾ã—ãŸã‹ï¼Ÿ</span> },
  // (v5.3 ä¿®æ­£2: "your homework" ã‚’ (s) => ... ã«å¤‰æ›´)
  { v: "do",    tail: (s) => `${getPossessive(s)} homework`, jp: (h) => <span>{h}<F rb="å®¿é¡Œ" rt="ã—ã‚…ãã ã„" />ã‚’ ã—ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "have",  tail: "lunch",           jp: (h) => <span>{h}<F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "study", tail: "English", jp: (h) => <span>{h}<F rb="è‹±èª" rt="ãˆã„ã”" />ã‚’ <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />ã—ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "clean", tail: "your room", jp: (h) => <span>{h}ã¸ã‚„ã‚’ <F rb="æƒé™¤" rt="ãã†ã˜" />ã—ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "listen", tail: "to music", jp: (h) => <span>{h}<F rb="éŸ³æ¥½" rt="ãŠã‚“ãŒã" />ã‚’ <F rb="è" rt="ã" />ãã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "talk", tail: "with Takeru", jp: (h) => <span>{h}ãŸã‘ã‚‹ãã‚“ã¨ <F rb="è©±" rt="ã¯ãª" />ã—ã¾ã—ãŸã‹ï¼Ÿ</span> },
  { v: "wash", tail: "the car", jp: (h) => <span>{h}<F rb="è»Š" rt="ãã‚‹ã¾" />ã‚’ <F rb="æ´—" rt="ã‚ã‚‰" />ã„ã¾ã—ãŸã‹ï¼Ÿ</span> },
];
const progressiveActs = [
  { ing: "playing soccer", jpPresent: <><F rb="ã‚µãƒƒã‚«ãƒ¼" rt="ã•ã£ã‹ãƒ¼" />ã‚’ ã—ã¦ã„ã¾ã™ã€‚</>, jpPast: <><F rb="ã‚µãƒƒã‚«ãƒ¼" rt="ã•ã£ã‹ãƒ¼" />ã‚’ ã—ã¦ã„ã¾ã—ãŸã€‚</> },
  { ing: "reading a book", jpPresent: <><F rb="æœ¬" rt="ã»ã‚“" />ã‚’ ã‚ˆã‚“ã§ã„ã¾ã™ã€‚</>, jpPast: <><F rb="æœ¬" rt="ã»ã‚“" />ã‚’ ã‚ˆã‚“ã§ã„ã¾ã—ãŸã€‚</> },
  { ing: "doing homework", jpPresent: <><F rb="å®¿é¡Œ" rt="ã—ã‚…ãã ã„" />ã‚’ ã—ã¦ã„ã¾ã™ã€‚</>, jpPast: <><F rb="å®¿é¡Œ" rt="ã—ã‚…ãã ã„" />ã‚’ ã—ã¦ã„ã¾ã—ãŸã€‚</> },
  { ing: "watching TV", jpPresent: <>ãƒ†ãƒ¬ãƒ“ã‚’ ã¿ã¦ã„ã¾ã™ã€‚</>, jpPast: <>ãƒ†ãƒ¬ãƒ“ã‚’ ã¿ã¦ã„ã¾ã—ãŸã€‚</> },
  { ing: "eating breakfast", jpPresent: <><F rb="æœã”é£¯" rt="ã‚ã•ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ" />ã¹ã¦ã„ã¾ã™ã€‚</>, jpPast: <><F rb="æœã”é£¯" rt="ã‚ã•ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ" />ã¹ã¦ã„ã¾ã—ãŸã€‚</> },
  { ing: "studying English", jpPresent: <><F rb="è‹±èª" rt="ãˆã„ã”" />ã‚’ <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />ã—ã¦ã„ã¾ã™ã€‚</>, jpPast: <><F rb="è‹±èª" rt="ãˆã„ã”" />ã‚’ <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />ã—ã¦ã„ã¾ã—ãŸã€‚</> },
];
const REG_PAIRS = [
  { base: "play", tail: "soccer", past: "played", jp: (h) => <span>{h}<F rb="ã‚µãƒƒã‚«ãƒ¼" rt="ã•ã£ã‹ãƒ¼" />ã‚’ ã—ã¾ã—ãŸã€‚</span> },
  { base: "watch", tail: "TV", past: "watched", jp: (h) => <span>{h}ãƒ†ãƒ¬ãƒ“ã‚’ ã¿ã¾ã—ãŸã€‚</span> },
  { base: "wash", tail: "your hands", past: "washed", jp: (h) => <span>{h}<F rb="æ‰‹" rt="ã¦" />ã‚’ <F rb="æ´—" rt="ã‚ã‚‰"/>ã„ã¾ã—ãŸã€‚</span> },
  { base: "talk", tail: "English", past: "talked", jp: (h) => <span>{h}<F rb="è‹±èª" rt="ãˆã„ã”" />ã‚’ <F rb="è©±" rt="ã¯ãª"/>ã—ã¾ã—ãŸã€‚</span> },
  { base: "clean", tail: "my room", past: "cleaned", jp: (h) => <span>{h}ã¸ã‚„ã‚’ <F rb="æƒé™¤" rt="ãã†ã˜" />ã—ã¾ã—ãŸã€‚</span> },
  { base: "study", tail: "math", past: "studied", jp: (h) => <span>{h}<F rb="ç®—æ•°" rt="ã•ã‚“ã™ã†" />ã‚’ <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />ã—ã¾ã—ãŸã€‚</span> },
  { base: "listen", tail: "to music", past: "listened", jp: (h) => <span>{h}<F rb="éŸ³æ¥½" rt="ãŠã‚“ãŒã" />ã‚’ <F rb="è" rt="ã" />ãã¾ã—ãŸã€‚</span> },
  { base: "use", tail: "a computer", past: "used", jp: (h) => <span>{h}ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã‚’ <F rb="ä½¿" rt="ã¤ã‹" />ã„ã¾ã—ãŸã€‚</span> },
];
const PRESENT_PAIRS = [
  { v: "play", tail: "soccer", jp: (h) => <span>{h}<F rb="ã‚µãƒƒã‚«ãƒ¼" rt="ã•ã£ã‹ãƒ¼" />ã‚’ ã—ã¾ã™ã€‚</span> },
  { v: "watch", tail: "TV", jp: (h) => <span>{h}ãƒ†ãƒ¬ãƒ“ã‚’ ã¿ã¾ã™ã€‚</span> },
  { v: "eat", tail: "lunch", jp: (h) => <span>{h}<F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã™ã€‚</span> },
  { v: "go", tail: "to school", jp: (h) => <span>{h}<F rb="å­¦æ ¡" rt="ãŒã£ã“ã†" />ã¸ <F rb="è¡Œ" rt="ã„"/>ãã¾ã™ã€‚</span> },
  { v: "read", tail: "a book", jp: (h) => <span>{h}<F rb="æœ¬" rt="ã»ã‚“" />ã‚’ <F rb="èª­" rt="ã‚ˆ"/>ã¿ã¾ã™ã€‚</span> },
  // (v5.3 ä¿®æ­£2: "your homework" ã‚’ (s) => ... ã«å¤‰æ›´)
  { v: "do", tail: (s) => `${getPossessive(s)} homework`, jp: (h) => <span>{h}<F rb="å®¿é¡Œ" rt="ã—ã‚…ãã ã„" />ã‚’ ã—ã¾ã™ã€‚</span> },
  { v: "have", tail: "lunch", jp: (h) => <span>{h}<F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã™ã€‚</span> },
  { v: "study", tail: "English", jp: (h) => <span>{h}<F rb="è‹±èª" rt="ãˆã„ã”" />ã‚’ <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />ã—ã¾ã™ã€‚</span> },
  { v: "clean", tail: "your room", jp: (h) => <span>{h}ã¸ã‚„ã‚’ <F rb="æƒé™¤" rt="ãã†ã˜" />ã—ã¾ã™ã€‚</span> },
  { v: "listen", tail: "to music", jp: (h) => <span>{h}<F rb="éŸ³æ¥½" rt="ãŠã‚“ãŒã" />ã‚’ <F rb="è" rt="ã" />ãã¾ã™ã€‚</span> },
  { v: "talk", tail: "with Takeru", jp: (h) => <span>{h}ãŸã‘ã‚‹ãã‚“ã¨ <F rb="è©±" rt="ã¯ãª" />ã—ã¾ã™ã€‚</span> },
  { v: "wash", tail: "the car", jp: (h) => <span>{h}<F rb="è»Š" rt="ãã‚‹ã¾" />ã‚’ <F rb="æ´—" rt="ã‚ã‚‰" />ã„ã¾ã™ã€‚</span> },
];
const PRESENT_Q_PAIRS = [
  { v: "play", tail: "soccer", jp: (h) => <span>{h}<F rb="ã‚µãƒƒã‚«ãƒ¼" rt="ã•ã£ã‹ãƒ¼" />ã‚’ ã—ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "watch", tail: "TV", jp: (h) => <span>{h}ãƒ†ãƒ¬ãƒ“ã‚’ ã¿ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "eat", tail: "lunch", jp: (h) => <span>{h}<F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "go", tail: "to school", jp: (h) => <span>{h}<F rb="å­¦æ ¡" rt="ãŒã£ã“ã†" />ã¸ <F rb="è¡Œ" rt="ã„"/>ãã¾ã™ã‹ï¼Ÿ</span> },
  { v: "read", tail: "a book", jp: (h) => <span>{h}<F rb="æœ¬" rt="ã»ã‚“" />ã‚’ <F rb="èª­" rt="ã‚ˆ"/>ã¿ã¾ã™ã‹ï¼Ÿ</span> },
  // (v5.3 ä¿®æ­£2: "your homework" ã‚’ (s) => ... ã«å¤‰æ›´)
  { v: "do", tail: (s) => `${getPossessive(s)} homework`, jp: (h) => <span>{h}<F rb="å®¿é¡Œ" rt="ã—ã‚…ãã ã„" />ã‚’ ã—ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "have", tail: "lunch", jp: (h) => <span>{h}<F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "study", tail: "English", jp: (h) => <span>{h}<F rb="è‹±èª" rt="ãˆã„ã”" />ã‚’ <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />ã—ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "clean", tail: "your room", jp: (h) => <span>{h}ã¸ã‚„ã‚’ <F rb="æƒé™¤" rt="ãã†ã˜" />ã—ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "listen", tail: "to music", jp: (h) => <span>{h}<F rb="éŸ³æ¥½" rt="ãŠã‚“ãŒã" />ã‚’ <F rb="è" rt="ã" />ãã¾ã™ã‹ï¼Ÿ</span> },
  { v: "talk", tail: "with Takeru", jp: (h) => <span>{h}ãŸã‘ã‚‹ãã‚“ã¨ <F rb="è©±" rt="ã¯ãª" />ã—ã¾ã™ã‹ï¼Ÿ</span> },
  { v: "wash", tail: "the car", jp: (h) => <span>{h}<F rb="è»Š" rt="ãã‚‹ã¾" />ã‚’ <F rb="æ´—" rt="ã‚ã‚‰" />ã„ã¾ã™ã‹ï¼Ÿ</span> },
];
const wordOrderPairs = [
  { v: "play", past: "played", tail: "soccer", jp: (<><F rb="ã‚µãƒƒã‚«ãƒ¼" rt="ã•ã£ã‹ãƒ¼" />ã‚’ ã—ã¾ã—ãŸã€‚</>) },
  { v: "watch", past: "watched", tail: "TV", jp: (<span>ãƒ†ãƒ¬ãƒ“ã‚’ ã¿ã¾ã—ãŸã€‚</span>) },
  { v: "eat", past: "ate", tail: "lunch", jp: (<><F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã—ãŸã€‚</>) },
  { v: "go", past: "went", tail: "to school", jp: (<><F rb="å­¦æ ¡" rt="ãŒã£ã“ã†" />ã¸ <F rb="è¡Œ" rt="ã„"/>ãã¾ã—ãŸã€‚</>) },
  { v: "read", past: "read", tail: "a book", jp: (<><F rb="æœ¬" rt="ã»ã‚“" />ã‚’ <F rb="èª­" rt="ã‚ˆ"/>ã¿ã¾ã—ãŸã€‚</>) },
  { v: "see", past: "saw", tail: "a bird", jp: (<><F rb="ã¨ã‚Š" rt="ã¨ã‚Š" />ã‚’ ã¿ã¾ã—ãŸã€‚</>) },
  { v: "clean", past: "cleaned", tail: "my room", jp: (<>ã¸ã‚„ã‚’ <F rb="æƒé™¤" rt="ãã†ã˜" />ã—ã¾ã—ãŸã€‚</>) },
  { v: "study", past: "studied", tail: "math", jp: (<><F rb="ç®—æ•°" rt="ã•ã‚“ã™ã†" />ã‚’ <F rb="å‹‰å¼·" rt="ã¹ã‚“ãã‚‡ã†" />ã—ã¾ã—ãŸã€‚</>) },
];
const wordOrderPlaces = ["at home", "in the park", "at school", "at the library", "under the tree"];
const wordOrderTimes = ["yesterday", "last night", "this morning", "on Sunday"];

const verbForms = {
  go: { singular: "goes", plural: "go" }, have: { singular: "has", plural: "have" },
  do: { singular: "does", plural: "do" }, watch: { singular: "watches", plural: "watch" },
  play: { singular: "plays", plural: "play" }, eat: { singular: "eats", plural: "eat" },
  read: { singular: "reads", plural: "read" },
  study: { singular: "studies", plural: "study" }, clean: { singular: "cleans", plural: "clean" },
  listen: { singular: "listens", plural: "listen" }, talk: { singular: "talks", plural: "talk" },
  wash: { singular: "washes", plural: "wash" },
};
const startsWithVowel = (w) => /^[aeiou]/i.test(w);
const jpImperativeV = (v) => ({ "Open": <><F rb="ã‚ã‘" rt="ã‚ã‘" />ã¦</>, "Close": <><F rb="ã—ã‚" rt="ã—ã‚" />ã¦</>, "Wash": <><F rb="ã‚ã‚‰" rt="ã‚ã‚‰" />ã£ã¦</>, "Bring": <><F rb="ã‚‚ã£" rt="ã‚‚ã£" />ã¦ãã¦</>, "Read": <><F rb="ã‚ˆ" rt="ã‚ˆ" />ã‚“ã§</>, }[v] || v);
const jpImperativeObj = (o) => ({ "the door": <><F rb="ãƒ‰ã‚¢" rt="ã©ã‚" />ã‚’</>, "your hands": <><F rb="æ‰‹" rt="ã¦" />ã‚’</>, "this book": <><F rb="ã“ã®æœ¬" rt="ã“ã®ã»ã‚“" />ã‚’</>, "the window": <><F rb="ã¾ã©" rt="ã¾ã©" />ã‚’</>, "your bag": <><F rb="ã‹ã°ã‚“" rt="ã‹ã°ã‚“" />ã‚’</>, }[o] || o);
const jpNounFromWord = (w) => { const base = w.endsWith('s') ? w.slice(0, -1) : w; return ({ bag: <><F rb="ã‹ã°ã‚“" rt="ã‹ã°ã‚“" /></>, car: <><F rb="ãã‚‹ã¾" rt="ãã‚‹ã¾" /></>, pen: <><F rb="ãƒšãƒ³" rt="ãºã‚“" /></>, book: <><F rb="æœ¬" rt="ã»ã‚“" /></>, cup: <><F rb="ã‚³ãƒƒãƒ—" rt="ã“ã£ã·" /></>, apple: <><F rb="ã‚Šã‚“ã”" rt="ã‚Šã‚“ã”" /></>, orange: <>ã‚ªãƒ¬ãƒ³ã‚¸</>, egg: <><F rb="ãŸã¾ã”" rt="ãŸã¾ã”" /></>, }[base]) || base; };

const genBeVerbPresent = () => {
  const subj = rand(ALL_SUBJECTS);
  const place = rand(["at home", "at school", "in the park", "at the library"]);
  const correct = subj === "I" ? "am" : ALL_SINGULAR_SUBJECTS.includes(subj) ? "is" : "are";
  const en = `${subj} ___ ${place}.`;
  const choices = ["am", "is", "are", "was"];
  const jp = (<span>{getJPSubj(subj)} {jpPlaceNi(place)} ã„ã¾ã™ã€‚</span>);
  // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
  return { type: "choice", en, choices, answerIndex: -1, correctAnswerText: correct,
            explainJP: <span><F rb="ä¸»èª" rt="ã—ã‚…ã”"/>ã«ã‚ˆã£ã¦<F rb="ä½¿" rt="ã¤ã‹"/>ã„<F rb="åˆ†" rt="ã‚"/>ã‘ã¾ã™ã€‚<b>I</b>â†’<b>am</b>, <b>He/She/Taro</b>â†’<b>is</b>, <b>You/We/They</b>â†’<b>are</b> ã§ã™ã€‚</span>,
            speak: en.replace("___", correct), jp };
};
const genBeVerbPast = () => {
  const subj = rand(ALL_SUBJECTS);
  const place = rand(["at home", "at school", "in the park", "at the library"]);
  const t = rand(["yesterday", "last night"]);
  const correct = (subj === "I" || ALL_SINGULAR_SUBJECTS.includes(subj)) ? "was" : "were";
  const en = `${subj} ___ ${place} ${t}.`;
  const choices = ["was", "were", "am", "is"];
  const jp = (<span>{getJPSubj(subj)} {jpTime(t)} {jpPlaceNi(place)} ã„ã¾ã—ãŸã€‚</span>);
  // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
  return { type: "choice", en, choices, answerIndex: -1, correctAnswerText: correct,
            explainJP: <span><F rb="éå»" rt="ã‹ã“"/>ã«ã€Œã€œã§ã—ãŸã€ã¨<F rb="è¨€" rt="ã„"/>ã†ã¨ãã¯ was/were ã‚’<F rb="ä½¿" rt="ã¤ã‹"/>ã„ã¾ã™ã€‚<b>I/He/She/Taro</b>â†’<b>was</b>, <b>You/We/They</b>â†’<b>were</b> ã§ã™ã€‚</span>,
            speak: en.replace("___", correct), jp };
};
const genPreposition = () => {
  const s = rand(prepoScenes);
  const subj = rand(["The ball", "The cat", "The book", "The picture"]);
  const choices = ["in", "on", "under", "next to", "behind", "near", "in front of", "between"];
  const blank = s.key;
  // (v5.4 ä¿®æ­£2: 'in front of' ãŒæ®‹ã‚‹ãƒã‚°ã‚’ä¿®æ­£ã€‚æ­£è¦è¡¨ç¾ã‹ã‚‰ s.key ã‚’ä½¿ã£ãŸç½®æ›ã«å¤‰æ›´)
  const en = `${subj} is ___ ${s.en.replace(s.key + ' ', '')}.`;
  const subjJP = subj === 'The ball' ? <><F rb="ãƒœãƒ¼ãƒ«" rt="ã¼ãƒ¼ã‚‹" /></> : subj === 'The cat' ? <><F rb="ã­ã“" rt="ã­ã“" /></> : subj === 'The book' ? <><F rb="æœ¬" rt="ã»ã‚“" /></> : <><F rb="çµµ" rt="ãˆ" /></>;
  const verbJP = subj === 'The cat' ? 'ã„ã¾ã™' : 'ã‚ã‚Šã¾ã™';
  const jp = (<span>{subjJP} ã¯ {jpPlace(s.en)} {verbJP}ã€‚</span>);
  return {
    type: "choice", en, 
    // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
    choices: [blank, ...choices],
    answerIndex: -1, // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
    correctAnswerText: blank, // â˜…ã“ã‚ŒãŒæ­£è§£ã®æ–‡å­—åˆ—
    explainJP: <span><b><F rb="å ´æ‰€" rt="ã°ã—ã‚‡"/></b>ã‚’<F rb="è¡¨" rt="ã‚ã‚‰ã‚"/>ã™ã“ã¨ã°ã§ã™ã€‚<code>in</code>ã¯ã€Œ<F rb="ä¸­" rt="ãªã‹"/>ã«ã€ã€<code>on</code>ã¯ã€Œ<F rb="ä¸Š" rt="ã†ãˆ"/>ã«ã€ã€<code>under</code>ã¯ã€Œ<F rb="ä¸‹" rt="ã—ãŸ"/>ã«ã€ã¨ã„ã†<F rb="æ„å‘³" rt="ã„ã¿"/>ã§ã™ã€‚</span>,
    speak: en.replace('___', blank), jp,
  };
};
const genThere = () => {
  const nouns = ["apple", "egg", "orange", "umbrella", "book", "bag", "cat", "dog"];
  const places = ["at home", "in the park", "at school", "on the desk", "under the table", "next to the chair", "in the box"];
  const n = Math.random() < 0.6 ? 1 : (Math.floor(Math.random() * 3) + 2);
  const noun = rand(nouns);
  const place = rand(places);
  const be = n === 1 ? "is" : "are";
  const art = n === 1 ? (startsWithVowel(noun) ? "an" : "a") : String(n);
  const en = `There ___ ${n === 1 ? art : n} ${n === 1 ? noun : noun + 's'} ${place}.`;
  const choices = ["is", "are", "am", "be"];
  const isAnimal = noun === 'cat' || noun === 'dog';
  const jp = (<span>{jpPlace(place)} ã« {nounJP(noun)} ãŒ {n === 1 ? '' : <>{n}<F rb="å€‹" rt="ã“" /> </>}{isAnimal ? 'ã„ã¾ã™' : 'ã‚ã‚Šã¾ã™'}ã€‚</span>);
  // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: be,
    explainJP: <span>ã€Œã€œãŒã‚ã‚Šã¾ã™ãƒ»ã„ã¾ã™ã€ã¨ã„ã†<F rb="æ–‡" rt="ã¶ã‚“"/>ã§ã™ã€‚<b><F rb="ä¸€" rt="ã²ã¨"/>ã¤</b>ã®ã¨ãã¯ <code>is</code>ã€<b><F rb="äºŒ" rt="ãµãŸ"/>ã¤<F rb="ä»¥ä¸Š" rt="ã„ã˜ã‚‡ã†"/></b>ã®ã¨ãã¯ <code>are</code> ã‚’<F rb="ä½¿" rt="ã¤ã‹"/>ã„ã¾ã™ã€‚</span>,
    speak: `There ${be} ${n === 1 ? art : n} ${n === 1 ? noun : noun + 's'} ${place}.`, jp,
  };
};
const genDid = () => {
  const subj = rand(ALL_Q_SUBJECTS.filter(s => s !== 'we'));
  const pair = rand(DID_PAIRS);
  const t = rand(["yesterday", "last night"]);
  // (v5.3 ä¿®æ­£2: pair.tail ãŒé–¢æ•°ã®å ´åˆã«å¯¾å¿œ)
  const tailText = typeof pair.tail === 'function' ? pair.tail(subj) : pair.tail;
  const en = `Did ${subj} ___ ${tailText} ${t}?`;
  // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
  const choices = [pair.v, pair.v + "s", pair.v + "ed", rand(["went", "ate", "did", "saw"])];
  const jpHead = <>{getJPSubj(subj)} {jpTime(t)} </>;
  const jp = pair.jp(jpHead);
  // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: pair.v,
    explainJP: <span>ã€Œã€œã—ã¾ã—ãŸã‹ï¼Ÿã€ã¨<F rb="éå»" rt="ã‹ã“"/>ã®<F rb="è³ªå•" rt="ã—ã¤ã‚‚ã‚“"/>ã‚’ã™ã‚‹ã¨ãã€<F rb="æ–‡" rt="ã¶ã‚“"/>ã®<F rb="æœ€åˆ" rt="ã•ã„ã—ã‚‡"/>ã« <code>Did</code> ã‚’<F rb="ç½®" rt="ãŠ"/>ã„ãŸã‚‰ã€<F rb="å‹•è©" rt="ã©ã†ã—"/>ã¯<b><F rb="å…ƒ" rt="ã‚‚ã¨"/>ã®<F rb="å½¢" rt="ã‹ãŸã¡"/>ï¼ˆ<F rb="åŸå½¢" rt="ã’ã‚“ã‘ã„"/>ï¼‰</b>ã«<F rb="æˆ»" rt="ã‚‚ã©"/>ã‚Šã¾ã™ã€‚</span>,
    // (v5.3 ä¿®æ­£2: pair.tail ãŒé–¢æ•°ã®å ´åˆã«å¯¾å¿œ)
    speak: `Did ${subj} ${pair.v} ${tailText} ${t}?`, jp,
  };
};
const genImperative = () => {
  const COMPAT = { Open: ["the door", "the window"], Close: ["the door", "the window"], Wash: ["your hands"], Bring: ["your bag", "this book"], Read: ["this book"], };
  const verbs = Object.keys(COMPAT);
  const v = rand(verbs);
  const o = rand(COMPAT[v]);
  const ans = [v, o, "!"];
  const jp = (<span>{jpImperativeObj(o)} {jpImperativeV(v)}ã€‚</span>);
  return {
    type: "arrange", tokens: ans, answer: ans, correctAnswerText: ans.join(' '),
    explainJP: <span>ã€Œã€œã—ãªã•ã„ã€ã¨ã„ã†<F rb="å‘½ä»¤" rt="ã‚ã„ã‚Œã„"/>ã®<F rb="æ–‡" rt="ã¶ã‚“"/>ã¯ã€<b><F rb="å‹•è©" rt="ã©ã†ã—"/></b>ã‹ã‚‰<F rb="å§‹" rt="ã¯ã˜"/>ã¾ã‚Šã¾ã™ã€‚</span>,
    speak: `${v} ${o}!`, jp,
  };
};
const genDemonstratives = () => {
  const near = Math.random() < 0.5;
  const plural = Math.random() < 0.5;
  const word = rand(["bag", "car", "pen", "book", "cup", "apple", "orange", "egg"]);
  const hint = near ? "(here)" : "(over there)";
  const correct = plural ? (near ? "These" : "Those") : (near ? "This" : "That");
  const tail = plural ? `${word}s` : (startsWithVowel(word) ? `an ${word}` : `a ${word}`);
  const choices = ["This", "That", "These", "Those"];
  const en = `___ ${plural ? "are" : "is"} ${tail} ${hint}.`;
  const nounJ = jpNounFromWord(tail);
  const jpPronoun = near ? (plural ? "ã“ã‚Œã‚‰" : "ã“ã‚Œ") : (plural ? "ã‚ã‚Œã‚‰" : "ã‚ã‚Œ");
  // (v5.3 ä¿®æ­£3: æ—¥æœ¬èªè¨³ã« ( ) ã‚’è¿½åŠ )
  const jp = (<span>{near ? '(ã“ã“ã«ã‚ã‚‹)' : '(ã‚ãã“ã«ã‚ã‚‹)'} {jpPronoun} ã¯ {nounJ} ã§ã™ã€‚</span>);
  // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: correct,
    explainJP: <span><b><F rb="è¿‘" rt="ã¡ã‹"/>ã„ã‚‚ã®</b>ã¯ <code>this</code> (<F rb="ä¸€" rt="ã²ã¨"/>ã¤) / <code>these</code> (ãŸãã•ã‚“)ã€<b><F rb="é " rt="ã¨ãŠ"/>ã„ã‚‚ã®</b>ã¯ <code>that</code> (<F rb="ä¸€" rt="ã²ã¨"/>ã¤) / <code>those</code> (ãŸãã•ã‚“) ã‚’<F rb="ä½¿" rt="ã¤ã‹"/>ã„ã¾ã™ã€‚</span>,
    speak: `${correct} ${plural ? "are" : "is"} ${tail}.`, jp,
  };
};
const genBeQuestion = () => {
  // (v5.3 ä¿®æ­£1: ALL_SUBJECTS -> BE_Q_SUBJECTS ã«å¤‰æ›´)
  const subj = rand(BE_Q_SUBJECTS);
  const place = rand(["at home", "at school", "in the park"]);
  // (v5.3 ä¿®æ­£1: ALL_SINGULAR_SUBJECTS.includes(subj) -> ... ã«å¤‰æ›´)
  const correct = subj === "I" ? "Am" : (["he", "she", "Taro", "Hanako"].includes(subj) ? "Is" : "Are");
  const en = `___ ${subj} ${place}?`;
  // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
  const choices = ["Am", "Is", "Are"];
  const jp = (<span>{getJPSubj(subj)} {jpPlaceNi(place)} ã„ã¾ã™ã‹ï¼Ÿ</span>);
  // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: correct,
    explainJP: <span>be<F rb="å‹•è©" rt="ã©ã†ã—"/>ã®<F rb="è³ªå•" rt="ã—ã¤ã‚‚ã‚“"/>ã¯ <code>Am</code>/<code>Is</code>/<code>Are</code> ã§<F rb="å§‹" rt="ã¯ã˜"/>ã‚ã¾ã™ã€‚<F rb="ä¸»èª" rt="ã—ã‚…ã”"/>ãŒ <b>I</b>â†’Am, <b>He/She/Taro</b>â†’Is, <b>You/We/They</b>â†’Are ã§ã™ã€‚</span>,
    speak: `${correct} ${subj} ${place}?`, jp,
  };
};
const genProgressive = () => {
  const subj = rand(ALL_SUBJECTS);
  const isPast = Math.random() < 0.5;
  const act = rand(progressiveActs);
  if (isPast) {
    const t = rand(["yesterday", "last night"]);
    const correct = (subj === "I" || ALL_SINGULAR_SUBJECTS.includes(subj)) ? "was" : "were";
    const en = `${subj} ___ ${act.ing} ${t}.`;
    // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
    const choices = ["was", "were", "is", "am"];
    const jp = (<span>{getJPSubj(subj)} {jpTime(t)} {act.jpPast}</span>);
    return {
      type: "choice", en, choices, answerIndex: -1, correctAnswerText: correct,
      explainJP: <span><F rb="éå»" rt="ã‹ã“"/>ã«ã€Œã€œã—ã¦ã„ã¾ã—ãŸã€ã¨<F rb="è¨€" rt="ã„"/>ã†ã¨ãã¯ <code>was</code> / <code>were</code> ã‚’<F rb="ä½¿" rt="ã¤ã‹"/>ã„ã¾ã™ã€‚<b>I/He/She/Taro</b>â†’was, <b>You/We/They</b>â†’were ã§ã™ã€‚</span>,
      speak: en.replace("___", correct), jp,
    };
  } else {
    const correct = subj === "I" ? "am" : ALL_SINGULAR_SUBJECTS.includes(subj) ? "is" : "are";
    const en = `${subj} ___ ${act.ing}.`;
    // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
    const choices = ["am", "is", "are", "was"];
    const jp = (<span>{getJPSubj(subj)} {act.jpPresent}</span>);
    return {
      type: "choice", en, choices, answerIndex: -1, correctAnswerText: correct,
      explainJP: <span><F rb="ä»Š" rt="ã„ã¾"/>ã€Œã€œã—ã¦ã„ã¾ã™ã€ã¨<F rb="è¨€" rt="ã„"/>ã†ã¨ãã¯ <code>am</code> / <code>is</code> / <code>are</code> ã‚’<F rb="ä½¿" rt="ã¤ã‹"/>ã„ã¾ã™ã€‚<b>I</b>â†’am, <b>He/She/Taro</b>â†’is, <b>You/We/They</b>â†’are ã§ã™ã€‚</span>,
      speak: en.replace("___", correct), jp,
    };
  }
};
const genVerbPastIrreg = () => {
  const subj = rand(ALL_SUBJECTS);
  const t = rand(["yesterday", "last night"]);
  const v = rand([
      { base: "go", past: "went", tail: "to school", jp: (<><F rb="å­¦æ ¡" rt="ãŒã£ã“ã†" />ã¸ <F rb="è¡Œ" rt="ã„"/>ãã¾ã—ãŸã€‚</>) },
      { base: "eat", past: "ate", tail: "lunch", jp: (<><F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ"/>ã¹ã¾ã—ãŸã€‚</>) },
      { base: "see", past: "saw", tail: "a bird", jp: (<><F rb="ã¨ã‚Š" rt="ã¨ã‚Š" />ã‚’ ã¿ã¾ã—ãŸã€‚</>) },
      { base: "read", past: "read", tail: "a book", jp: (<><F rb="æœ¬" rt="ã»ã‚“" />ã‚’ <F rb="èª­" rt="ã‚ˆ"/>ã¿ã¾ã—ãŸã€‚</>) },
      { base: "have", past: "had", tail: "lunch", jp: (<><F rb="æ˜¼ã”é£¯" rt="ã²ã‚‹ã”ã¯ã‚“" />ã‚’ <F rb="é£Ÿ" rt="ãŸ" />ã¹ã¾ã—ãŸã€‚</>) },
      // (v5.3 ä¿®æ­£2: "my homework" ã‚’ (s) => ... ã«å¤‰æ›´)
      { base: "do", past: "did", tail: (s) => `${getPossessive(s)} homework`, jp: (<><F rb="å®¿é¡Œ" rt="ã—ã‚…ãã ã„" />ã‚’ ã—ã¾ã—ãŸã€‚</>) },
      { base: "make", past: "made", tail: "a cake", jp: (<>ã‚±ãƒ¼ã‚­ã‚’ <F rb="ä½œ" rt="ã¤ã" />ã‚Šã¾ã—ãŸã€‚</>) },
      { base: "get", past: "got", tail: "a present", jp: (<>ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã‚’ ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚</>) },
  ]);
  // (v5.3 ä¿®æ­£2: v.tail ãŒé–¢æ•°ã®å ´åˆã«å¯¾å¿œ)
  const tailText = typeof v.tail === 'function' ? v.tail(subj) : v.tail;
  const en = `${subj} ___ ${tailText} ${t}.`;
  // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
  const choices = [v.past, v.base + "ed", v.base, v.past + "ed"];
  const jp = (<span>{getJPSubj(subj)} {jpTime(t)} {v.jp}</span>);
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: v.past,
    explainJP: <span><F rb="å‹•è©" rt="ã©ã†ã—"/>ã®<F rb="ä¸­" rt="ãªã‹"/>ã«ã¯ã€<F rb="éå»" rt="ã‹ã“"/>ã®<F rb="å½¢" rt="ã‹ãŸã¡"/>ãŒ <b>ed</b> ã§ã¯ãªã„<F rb="ç‰¹åˆ¥" rt="ã¨ãã¹ã¤"/>ãª<F rb="å½¢" rt="ã‹ãŸã¡"/>ã«<F rb="å¤‰" rt="ã‹"/>ã‚ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ (<F rb="ä¾‹" rt="ã‚Œã„"/>: go â†’ went)ã€‚ã“ã‚Œã‚’<b><F rb="ä¸è¦å‰‡å‹•è©" rt="ãµãããã©ã†ã—"/></b>ã¨ã„ã„ã¾ã™ã€‚</span>,
    speak: en.replace('___', v.past), jp,
  };
};
const genVerbPastReg = () => {
  const subj = rand(ALL_SUBJECTS);
  const pair = rand(REG_PAIRS);
  const t = rand(["yesterday", "last night"]);
  const en = `${subj} ___ ${pair.tail} ${t}.`;
  // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
  const choices = [pair.past, pair.base, pair.base + "s", pair.base + "ing"];
  const jp = (<span>{getJPSubj(subj)} {jpTime(t)} {pair.jp('')}</span>);
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: pair.past,
    explainJP: <span><F rb="éå»" rt="ã‹ã“"/>ã«ã€Œã€œã—ã¾ã—ãŸã€ã¨<F rb="è¨€" rt="ã„"/>ã†ã¨ãã€<F rb="å¤š" rt="ãŠãŠ"/>ãã®<F rb="å‹•è©" rt="ã©ã†ã—"/>ã¯ã†ã—ã‚ã« <b>ed</b> ã‚’<F rb="ä»˜" rt="ã¤"/>ã‘ã¾ã™ã€‚ã“ã‚Œã‚’<b><F rb="è¦å‰‡å‹•è©" rt="ãããã©ã†ã—"/></b>ã¨ã„ã„ã¾ã™ã€‚</span>,
    speak: en.replace('___', pair.past), jp,
  };
};
const genVerbPresent = () => {
  const subj = rand(ALL_SUBJECTS);
  const pair = rand(PRESENT_PAIRS);
  // (v5.3 ä¿®æ­£2: pair.tail ãŒé–¢æ•°ã®å ´åˆã«å¯¾å¿œ)
  const tailText = typeof pair.tail === 'function' ? pair.tail(subj) : pair.tail;
  const en = `${subj} ___ ${tailText}.`;
  const correctForm = ALL_SINGULAR_SUBJECTS.includes(subj) ? (verbForms[pair.v]?.singular ?? (pair.v + "s")) : (verbForms[pair.v]?.plural ?? pair.v);
  // (v6.2 ä¿®æ­£1: ensureFourChoices ã®äºŒé‡å‘¼ã³å‡ºã—ã‚’é˜²ããŸã‚ã€å€™è£œãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾æ¸¡ã™)
  const choices = [correctForm, pair.v + "ed", verbForms[pair.v]?.plural ?? pair.v, verbForms[pair.v]?.singular ?? (pair.v + "s")];
  const jp = pair.jp(getJPSubj(subj));
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: correctForm,
    explainJP: <span><F rb="ä¸»èª" rt="ã—ã‚…ã”"/>ãŒ <b>He / She / Taro</b> ã®ã¨ãã€<F rb="å‹•è©" rt="ã©ã†ã—"/>ã« <b>s</b> ã‚„ <b>es</b> ã‚’<F rb="ä»˜" rt="ã¤"/>ã‘ã¾ã™ (<F rb="ä¾‹" rt="ã‚Œã„"/>: playâ†’plays, goâ†’goes)ã€‚ã“ã‚Œã‚’<F rb="ä¸‰å˜ç¾" rt="ã•ã‚“ãŸã‚“ã’ã‚“"/>ã®sã¨ã„ã„ã¾ã™ã€‚</span>,
    speak: en.replace('___', correctForm), jp,
  };
};
const genPresentQuestion = () => {
  const subj = rand(ALL_Q_SUBJECTS);
  const pair = rand(PRESENT_Q_PAIRS);
  // (v5.3 ä¿®æ­£2: pair.tail ãŒé–¢æ•°ã®å ´åˆã«å¯¾å¿œ)
  const tailText = typeof pair.tail === 'function' ? pair.tail(subj) : pair.tail;
  const en = `___ ${subj} ${pair.v} ${tailText}?`;
  const choices = ["Do", "Does", "Did", "Is"];
  const correct = ALL_SINGULAR_SUBJECTS.map(s => s.toLowerCase()).includes(subj) ? "Does" : "Do";
  const jp = pair.jp(getJPSubj(subj));
  // (v6.2 ä¿®æ­£1: answerIndex ã¯ä½¿ã‚ãªã„ã®ã§ -1 ã«)
  return {
    type: "choice", en, choices, answerIndex: -1, correctAnswerText: correct,
    explainJP: <span><F rb="è³ªå•" rt="ã—ã¤ã‚‚ã‚“"/>ã®<F rb="æ–‡" rt="ã¶ã‚“"/>ã§ã€<F rb="ä¸»èª" rt="ã—ã‚…ã”"/>ãŒ <b>He / She / Taro</b> ãªã‚‰ <code>Does</code>ã€ãã®<F rb="ä»–" rt="ã»ã‹"/>ã¯ <code>Do</code> ã‹ã‚‰<F rb="å§‹" rt="ã¯ã˜"/>ã‚ã¾ã™ã€‚</span>,
    // (v5.3 ä¿®æ­£2: pair.tail ãŒé–¢æ•°ã®å ´åˆã«å¯¾å¿œ)
    speak: `${correct} ${subj} ${pair.v} ${tailText}?`, jp,
  };
};
const genWordOrder = () => {
  const subj = rand(ALL_SUBJECTS);
  const pair = rand(wordOrderPairs);
  const place = rand(wordOrderPlaces);
  const t = rand(wordOrderTimes);
  const ans = [subj, pair.past, pair.tail, place, t, "."];
  const jp = (<span>{getJPSubj(subj)} {jpTime(t)} {jpPlace(place)} {pair.jp}</span>);
  return {
    type: "arrange", tokens: ans, answer: ans, correctAnswerText: ans.join(' '),
    explainJP: <span><F rb="è‹±èª" rt="ãˆã„ã”"/>ã®<F rb="æ–‡" rt="ã¶ã‚“"/>ã¯ã€<F rb="æ™®é€š" rt="ãµã¤ã†"/> [<F rb="èª°" rt="ã ã‚Œ"/>ãŒ]â†’[<F rb="ä½•" rt="ãªã«"/>ã™ã‚‹]â†’[<F rb="ä½•" rt="ãªã«"/>ã‚’]â†’[ã©ã“ã§]â†’[ã„ã¤] ã®<F rb="é †ç•ª" rt="ã˜ã‚…ã‚“ã°ã‚“"/>ã«<F rb="ä¸¦" rt="ãªã‚‰"/>ã¹ã¾ã™ã€‚</span>,
    speak: ans.join(' '), jp,
  };
};

const LESSONS = [
  { id: "be-verb", name: <><F rb="beå‹•è©" rt="ã³ãƒ¼ã©ã†ã—" />ï¼ˆ<F rb="ç¾åœ¨" rt="ã’ã‚“ã–ã„" />ï¼‰ am/is/are</>,
    generator: genBeVerbPresent,
  },
  { id: "be-question", name: <><F rb="beå‹•è©" rt="ã³ãƒ¼ã©ã†ã—" />ã®<F rb="ç–‘å•æ–‡" rt="ãã‚‚ã‚“ã¶ã‚“" /></>, generator: genBeQuestion },
  { id: "verb-present", name: <><F rb="ä¸€èˆ¬å‹•è©" rt="ã„ã£ã±ã‚“ã©ã†ã—" />ï¼ˆ<F rb="ç¾åœ¨å½¢" rt="ã’ã‚“ã–ã„ã‘ã„" />ï¼‰</>, generator: genVerbPresent },
  { id: "present-q", name: <><F rb="ä¸€èˆ¬å‹•è©" rt="ã„ã£ã±ã‚“ã©ã†ã—" />ã®<F rb="ç–‘å•æ–‡" rt="ãã‚‚ã‚“ã¶ã‚“" /> (Do/Does)</>, generator: genPresentQuestion },
  { id: "be-verb-past", name: <><F rb="beå‹•è©" rt="ã³ãƒ¼ã©ã†ã—" />ï¼ˆ<F rb="éå»" rt="ã‹ã“" />ï¼‰ was/were</>,
    generator: genBeVerbPast,
  },
  { id: "verb-past-reg", name: <><F rb="ä¸€èˆ¬å‹•è©" rt="ã„ã£ã±ã‚“ã©ã†ã—" />ã®<F rb="éå»" rt="ã‹ã“" />ï¼ˆ<F rb="è¦å‰‡å¤‰åŒ–" rt="ãããã¸ã‚“ã‹" />ï¼‰</>, generator: genVerbPastReg },
  { id: "verb-past-irregular", name: <><F rb="ä¸€èˆ¬å‹•è©" rt="ã„ã£ã±ã‚“ã©ã†ã—" />ã®<F rb="éå»" rt="ã‹ã“" />ï¼ˆ<F rb="ä¸è¦å‰‡" rt="ãµããã" />ï¼‰</>, generator: genVerbPastIrreg },
  { id: "progressive", name: <><F rb="é€²è¡Œå½¢" rt="ã—ã‚“ã“ã†ã‘ã„" />ï¼ˆ<F rb="ç¾åœ¨" rt="ã’ã‚“ã–ã„" />/<F rb="éå»" rt="ã‹ã“" />ï¼‰</>, generator: genProgressive },
  { id: "word-order", name: <><F rb="èªé †" rt="ã”ã˜ã‚…ã‚“" /><F rb="ä¸¦" rt="ãªã‚‰" />ã¹<F rb="æ›¿" rt="ã‹" />ãˆ</>, generator: genWordOrder },
  { id: "imperative", name: <><F rb="å‘½ä»¤æ–‡" rt="ã‚ã„ã‚Œã„ã¶ã‚“" />ï¼ˆ<F rb="ä¸¦" rt="ãªã‚‰" />ã¹<F rb="æ›¿" rt="ã‹" />ãˆï¼‰</>, generator: genImperative },
  { id: "preposition", name: <><F rb="å‰ç½®è©" rt="ãœã‚“ã¡ã—" /> in/on/underâ€¦</>, generator: genPreposition },
  { id: "there-is-are", name: <>There is / There are</>, generator: genThere },
  { id: "demonstratives", name: <>this/that/these/those</>, generator: genDemonstratives },
  { id: "did-q", name: <>Did ã®<F rb="ç–‘å•æ–‡" rt="ãã‚‚ã‚“ã¶ã‚“" /></>, generator: genDid },
  {
    id: "mixed-verbs-1",
    name: <><F rb="ãµãã”ã†å•é¡Œ" rt="ãµãã”ã†ã‚‚ã‚“ã ã„" /> (ã„ã‚ã„ã‚ãª<F rb="å‹•è©" rt="ã©ã†ã—" />)</>,
    generator: () => {
      const gens = [
        genBeVerbPresent,
        genBeVerbPast,
        genVerbPresent, // ä¸€èˆ¬å‹•è©ï¼ˆç¾åœ¨ï¼‰
        genVerbPastReg, // ä¸€èˆ¬å‹•è©ï¼ˆéå»ãƒ»è¦å‰‡ï¼‰
        genVerbPastIrreg, // ä¸€èˆ¬å‹•è©ï¼ˆéå»ãƒ»ä¸è¦å‰‡ï¼‰
        genProgressive, // é€²è¡Œå½¢
        genBeQuestion, // beå‹•è© ç–‘å•æ–‡
        genPresentQuestion, // ä¸€èˆ¬å‹•è© ç–‘å•æ–‡
        genDid, // Did ç–‘å•æ–‡
      ];
      const gen = rand(gens);
      return gen();
    }
  }
];

// (v5.8 ä¿®æ­£1: v5.1ã§è¿½åŠ ã—ã€v5.2ä»¥é™ã§æ¬ è½ã—ã¦ã„ãŸã‚«ãƒ¼ãƒ‰å®šç¾©ã‚’å†è¿½åŠ )
// ===== ã‚¬ãƒãƒ£ãƒ»ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ =====
// (v6.2 ä¿®æ­£4: ã‚«ãƒ¼ãƒ‰ã‚’100ç¨®é¡ã«å€å¢—)
const CARDS = [
  // N (Normal) - 20ç¨®é¡
  { id: "cat_n", name: "ã­ã“", emoji: 'ğŸ±', rarity: 'N' },
  { id: "dog_n", name: "ã„ã¬", emoji: 'ğŸ¶', rarity: 'N' },
  { id: "mouse_n", name: "ã­ãšã¿", emoji: 'ğŸ­', rarity: 'N' },
  { id: "hamster_n", name: "ãƒãƒ ã‚¹ã‚¿ãƒ¼", emoji: 'ğŸ¹', rarity: 'N' },
  { id: "rabbit_n", name: "ã†ã•ã", emoji: 'ğŸ°', rarity: 'N' },
  { id: "chick_n", name: "ã²ã‚ˆã“", emoji: 'ğŸ¤', rarity: 'N' },
  { id: "frog_n", name: "ã‹ãˆã‚‹", emoji: 'ğŸ¸', rarity: 'N' },
  { id: "pig_n", name: "ã¶ãŸ", emoji: 'ğŸ·', rarity: 'N' },
  { id: "bee_n", name: "ã¯ã¡", emoji: 'ğŸ', rarity: 'N' },
  { id: "ant_n", name: "ã‚ã‚Š", emoji: 'ğŸœ', rarity: 'N' },
  { id: "insect_n", name: "ã“ã‚“ã¡ã‚…ã†", emoji: 'ğŸ', rarity: 'N' }, // 11
  { id: "fish_n", name: "ã•ã‹ãª", emoji: 'ğŸŸ', rarity: 'N' },
  { id: "bird_n", name: "ã¨ã‚Š", emoji: 'ğŸ¦', rarity: 'N' },
  { id: "shell_n", name: "ã‹ã„ãŒã‚‰", emoji: 'ğŸš', rarity: 'N' },
  { id: "tree_n", name: "ã", emoji: 'ğŸŒ³', rarity: 'N' },
  { id: "flower_n", name: "ã¯ãª", emoji: 'ğŸŒ¸', rarity: 'N' },
  { id: "star_n", name: "ã»ã—", emoji: 'â­', rarity: 'N' },
  { id: "moon_n", name: "ã¤ã", emoji: 'ğŸŒ™', rarity: 'N' },
  { id: "sun_n", name: "ãŸã„ã‚ˆã†", emoji: 'â˜€ï¸', rarity: 'N' },
  { id: "cloud_n", name: "ãã‚‚", emoji: 'â˜ï¸', rarity: 'N' }, // 20

  // R (Rare) - 20ç¨®é¡
  { id: "fox_r", name: "ãã¤ã­", emoji: 'ğŸ¦Š', rarity: 'R' },
  { id: "bear_r", name: "ãã¾", emoji: 'ğŸ»', rarity: 'R' },
  { id: "panda_r", name: "ãƒ‘ãƒ³ãƒ€", emoji: 'ğŸ¼', rarity: 'R' },
  { id: "koala_r", name: "ã‚³ã‚¢ãƒ©", emoji: 'ğŸ¨', rarity: 'R' },
  { id: "tiger_r", name: "ã¨ã‚‰", emoji: 'ğŸ¯', rarity: 'R' },
  { id: "lion_r", name: "ãƒ©ã‚¤ã‚ªãƒ³", emoji: 'ğŸ¦', rarity: 'R' },
  { id: "cow_r", name: "ã†ã—", emoji: 'ğŸ®', rarity: 'R' },
  { id: "monkey_r", name: "ã•ã‚‹", emoji: 'ğŸµ', rarity: 'R' },
  { id: "owl_r", name: "ãµãã‚ã†", emoji: 'ğŸ¦‰', rarity: 'R' },
  { id: "penguin_r", name: "ãƒšãƒ³ã‚®ãƒ³", emoji: 'ğŸ§', rarity: 'R' },
  { id: "squirrel_r", name: "ãƒªã‚¹", emoji: 'ğŸ¿ï¸', rarity: 'R' }, // 11
  { id: "raccoon_r", name: "ã‚¢ãƒ©ã‚¤ã‚°ãƒ", emoji: 'ğŸ¦', rarity: 'R' },
  { id: "skunk_r", name: "ã‚¹ã‚«ãƒ³ã‚¯", emoji: 'ğŸ¦¨', rarity: 'R' },
  { id: "badger_r", name: "ã‚¢ãƒŠã‚°ãƒ", emoji: 'ğŸ¦¡', rarity: 'R' },
  { id: "otter_r", name: "ã‚«ãƒ¯ã‚¦ã‚½", emoji: 'ğŸ¦¦', rarity: 'R' },
  { id: "beaver_r", name: "ãƒ“ãƒ¼ãƒãƒ¼", emoji: 'ğŸ¦«', rarity: 'R' },
  { id: "duck_r", name: "ã‚¢ãƒ’ãƒ«", emoji: 'ğŸ¦†', rarity: 'R' },
  { id: "swan_r", name: "ã¯ãã¡ã‚‡ã†", emoji: 'ğŸ¦¢', rarity: 'R' },
  { id: "rooster_r", name: "ã‚ªãƒ³ãƒ‰ãƒª", emoji: 'ğŸ”', rarity: 'R' },
  { id: "sheep_r", name: "ã²ã¤ã˜", emoji: 'ğŸ‘', rarity: 'R' }, // 20

  // SR (Super Rare) - 20ç¨®é¡
  { id: "wolf_sr", name: "ãŠãŠã‹ã¿", emoji: 'ğŸº', rarity: 'SR' },
  { id: "boar_sr", name: "ã„ã®ã—ã—", emoji: 'ğŸ—', rarity: 'SR' },
  { id: "horse_sr", name: "ã†ã¾", emoji: 'ğŸ´', rarity: 'SR' },
  { id: "zebra_sr", name: "ã—ã¾ã†ã¾", emoji: 'ğŸ¦“', rarity: 'SR' },
  { id: "deer_sr", name: "ã—ã‹", emoji: 'ğŸ¦Œ', rarity: 'SR' },
  { id: "giraffe_sr", name: "ãã‚Šã‚“", emoji: 'ğŸ¦’', rarity: 'SR' },
  { id: "elephant_sr", name: "ãã†", emoji: 'ğŸ˜', rarity: 'SR' },
  { id: "rhino_sr", name: "ã•ã„", emoji: 'ğŸ¦', rarity: 'SR' },
  { id: "hippo_sr", name: "ã‹ã°", emoji: 'ğŸ¦›', rarity: 'SR' },
  { id: "camel_sr", name: "ã‚‰ãã ", emoji: 'ğŸª', rarity: 'SR' },
  { id: "kangaroo_sr", name: "ã‚«ãƒ³ã‚¬ãƒ«ãƒ¼", emoji: 'ğŸ¦˜', rarity: 'SR' }, // 11
  { id: "crocodile_sr", name: "ãƒ¯ãƒ‹", emoji: 'ğŸŠ', rarity: 'SR' },
  { id: "snake_sr", name: "ãƒ˜ãƒ“", emoji: 'ğŸ', rarity: 'SR' },
  { id: "lizard_sr", name: "ãƒˆã‚«ã‚²", emoji: 'ğŸ¦', rarity: 'SR' },
  { id: "turtle_sr", name: "ã‚«ãƒ¡", emoji: 'ğŸ¢', rarity: 'SR' },
  { id: "sloth_sr", name: "ãƒŠãƒã‚±ãƒ¢ãƒ", emoji: 'ğŸ¦¥', rarity: 'SR' },
  { id: "peacock_sr", name: "ã‚¯ã‚¸ãƒ£ã‚¯", emoji: 'ğŸ¦š', rarity: 'SR' },
  { id: "parrot_sr", name: "ã‚ªã‚¦ãƒ ", emoji: 'ğŸ¦œ', rarity: 'SR' },
  { id: "flamingo_sr", name: "ãƒ•ãƒ©ãƒŸãƒ³ã‚´", emoji: 'ğŸ¦©', rarity: 'SR' },
  { id: "toucan_sr", name: "ã‚ªã‚ªãƒã‚·", emoji: 'ğŸ¦', rarity: 'SR' }, // 20 (çµµæ–‡å­—ã‹ã¶ã‚Š) -> ğŸ¦œ

  // SSR (Super Super Rare) - 20ç¨®é¡
  { id: "dolphin_ssr", name: "ã„ã‚‹ã‹", emoji: 'ğŸ¬', rarity: 'SSR' },
  { id: "whale_ssr", name: "ãã˜ã‚‰", emoji: 'ğŸ³', rarity: 'SSR' },
  { id: "shark_ssr", name: "ã•ã‚", emoji: 'ğŸ¦ˆ', rarity: 'SSR' },
  { id: "octopus_ssr", name: "ãŸã“", emoji: 'ğŸ™', rarity: 'SSR' },
  { id: "squid_ssr", name: "ã„ã‹", emoji: 'ğŸ¦‘', rarity: 'SSR' },
  { id: "crab_ssr", name: "ã‹ã«", emoji: 'ğŸ¦€', rarity: 'SSR' },
  { id: "shrimp_ssr", name: "ãˆã³", emoji: 'ğŸ¦', rarity: 'SSR' },
  { id: "eagle_ssr", name: "ã‚ã—", emoji: 'ğŸ¦…', rarity: 'SSR' },
  { id: "bat_ssr", name: "ã“ã†ã‚‚ã‚Š", emoji: 'ğŸ¦‡', rarity: 'SSR' },
  { id: "gorilla_ssr", name: "ã‚´ãƒªãƒ©", emoji: 'ğŸ¦', rarity: 'SSR' },
  { id: "scorpion_ssr", name: "ã‚µã‚½ãƒª", emoji: 'ğŸ¦‚', rarity: 'SSR' }, // 11
  { id: "spider_ssr", name: "ã‚¯ãƒ¢", emoji: 'ğŸ•·ï¸', rarity: 'SSR' },
  { id: "butterfly_ssr", name: "ãƒãƒ§ã‚¦", emoji: 'ğŸ¦‹', rarity: 'SSR' },
  { id: "ladybug_ssr", name: "ãƒ†ãƒ³ãƒˆã‚¦ãƒ ã‚·", emoji: 'ğŸ', rarity: 'SSR' }, // (çµµæ–‡å­—ã‹ã¶ã‚Š)
  { id: "seal_ssr", name: "ã‚¢ã‚¶ãƒ©ã‚·", emoji: 'ğŸ¦­', rarity: 'SSR' },
  { id: "walrus_ssr", name: "ã‚»ã‚¤ã‚¦ãƒ", emoji: 'ğŸ¦­', rarity: 'SSR' }, // (çµµæ–‡å­—ã‹ã¶ã‚Š)
  { id: "polar_bear_ssr", name: "ã‚·ãƒ­ã‚¯ãƒ", emoji: 'ğŸ»â€â„ï¸', rarity: 'SSR' },
  { id: "reindeer_ssr", name: "ãƒˆãƒŠã‚«ã‚¤", emoji: 'ğŸ¦Œ', rarity: 'SSR' }, // (çµµæ–‡å­—ã‹ã¶ã‚Š)
  { id: "bison_ssr", name: "ãƒã‚¤ã‚½ãƒ³", emoji: 'ğŸƒ', rarity: 'SSR' },
  { id: "moose_ssr", name: "ãƒ˜ãƒ©ã‚¸ã‚«", emoji: 'ğŸ¦Œ', rarity: 'SSR' }, // (çµµæ–‡å­—ã‹ã¶ã‚Š) -> ğŸ« (ãªã„ã‹ã‚‚)
  
  // L (Legendary) - 20ç¨®é¡
  { id: "t_rex_l", name: "ãƒ†ã‚£ãƒ©ãƒã‚µã‚¦ãƒ«ã‚¹", emoji: 'ğŸ¦–', rarity: 'L' },
  { id: "sauropod_l", name: "ãƒ–ãƒ©ã‚­ã‚ªã‚µã‚¦ãƒ«ã‚¹", emoji: 'ğŸ¦•', rarity: 'L' },
  { id: "dragon_l", name: "ãƒ‰ãƒ©ã‚´ãƒ³", emoji: 'ğŸ‰', rarity: 'L' },
  { id: "unicorn_l", name: "ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³", emoji: 'ğŸ¦„', rarity: 'L' },
  { id: "comet_l", name: "ã™ã„ã›ã„", emoji: 'â˜„ï¸', rarity: 'L' },
  { id: "alien_l", name: "ã†ã¡ã‚…ã†ã˜ã‚“", emoji: 'ğŸ‘½', rarity: 'L' },
  { id: "robot_l", name: "ãƒ­ãƒœãƒƒãƒˆ", emoji: 'ğŸ¤–', rarity: 'L' },
  { id: "ghost_l", name: "ãŠã°ã‘", emoji: 'ğŸ‘»', rarity: 'L' },
  { id: "volcano_l", name: "ã‹ã–ã‚“", emoji: 'ğŸŒ‹', rarity: 'L' },
  { id: "galaxy_l", name: "ãã‚“ãŒ", emoji: 'ğŸŒŒ', rarity: 'L' },
  { id: "phoenix_l", name: "ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹", emoji: 'ğŸ”¥', rarity: 'L' }, // 11 (çµµæ–‡å­—ä»£ç”¨)
  { id: "griffin_l", name: "ã‚°ãƒªãƒ•ã‚©ãƒ³", emoji: 'ğŸ¦…', rarity: 'L' }, // (çµµæ–‡å­—ã‹ã¶ã‚Š)
  { id: "kraken_l", name: "ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³", emoji: 'ğŸ™', rarity: 'L' }, // (çµµæ–‡å­—ã‹ã¶ã‚Š)
  { id: "hydra_l", name: "ãƒ’ãƒ‰ãƒ©", emoji: 'ğŸ²', rarity: 'L' },
  { id: "pegasus_l", name: "ãƒšã‚¬ã‚µã‚¹", emoji: 'ğŸ', rarity: 'L' }, // (çµµæ–‡å­—ä»£ç”¨)
  { id: "cerberus_l", name: "ã‚±ãƒ«ãƒ™ãƒ­ã‚¹", emoji: 'ğŸ•', rarity: 'L' }, // (çµµæ–‡å­—ä»£ç”¨)
  { id: "ninja_l", name: "ãƒ‹ãƒ³ã‚¸ãƒ£", emoji: 'ğŸ¥·', rarity: 'L' },
  { id: "samurai_l", name: "ã‚µãƒ ãƒ©ã‚¤", emoji: 'âš”ï¸', rarity: 'L' },
  { id: "ufo_l", name: "UFO", emoji: 'ğŸ›¸', rarity: 'L' },
  { id: "black_hole_l", name: "ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«", emoji: 'âš«', rarity: 'L' }, // 20
];
// (v6.2 ä¿®æ­£4: çµµæ–‡å­—ã®é‡è¤‡ã‚’èª¿æ•´)
// L: griffin_l -> ğŸ¦ (lion_r ã¨ã‹ã¶ã‚‹) -> ğŸ¦… (eagle_ssr ã¨ã‹ã¶ã‚‹) -> ğŸª½ (wing)
// L: kraken_l -> ğŸ™ (octopus_ssr ã¨ã‹ã¶ã‚‹) -> ğŸ¦‘ (squid_ssr ã¨ã‹ã¶ã‚‹) -> ğŸŒŠ (wave)
// SSR: ladybug_ssr -> ğŸ (insect_n ã¨ã‹ã¶ã‚‹) -> ğŸ (ãã®ã¾ã¾)
// SSR: walrus_ssr -> ğŸ¦­ (seal_ssr ã¨ã‹ã¶ã‚‹) -> ğŸ¦­ (ãã®ã¾ã¾)
// SSR: reindeer_ssr -> ğŸ¦Œ (deer_sr ã¨ã‹ã¶ã‚‹) -> ğŸ¦Œ (ãã®ã¾ã¾)
// SSR: moose_ssr -> ğŸ¦Œ (deer_sr ã¨ã‹ã¶ã‚‹) -> ğŸ¦Œ (ãã®ã¾ã¾)
const CARDS_V6_2 = [
  // N (Normal) - 20ç¨®é¡
  { id: "cat_n", name: "ã­ã“", emoji: 'ğŸ±', rarity: 'N' },
  { id: "dog_n", name: "ã„ã¬", emoji: 'ğŸ¶', rarity: 'N' },
  { id: "mouse_n", name: "ã­ãšã¿", emoji: 'ğŸ­', rarity: 'N' },
  { id: "hamster_n", name: "ãƒãƒ ã‚¹ã‚¿ãƒ¼", emoji: 'ğŸ¹', rarity: 'N' },
  { id: "rabbit_n", name: "ã†ã•ã", emoji: 'ğŸ°', rarity: 'N' },
  { id: "chick_n", name: "ã²ã‚ˆã“", emoji: 'ğŸ¤', rarity: 'N' },
  { id: "frog_n", name: "ã‹ãˆã‚‹", emoji: 'ğŸ¸', rarity: 'N' },
  { id: "pig_n", name: "ã¶ãŸ", emoji: 'ğŸ·', rarity: 'N' },
  { id: "bee_n", name: "ã¯ã¡", emoji: 'ğŸ', rarity: 'N' },
  { id: "ant_n", name: "ã‚ã‚Š", emoji: 'ğŸœ', rarity: 'N' },
  { id: "insect_n", name: "ã“ã‚“ã¡ã‚…ã†", emoji: 'ğŸ', rarity: 'N' }, // 11
  { id: "fish_n", name: "ã•ã‹ãª", emoji: 'ğŸŸ', rarity: 'N' },
  { id: "bird_n", name: "ã¨ã‚Š", emoji: 'ğŸ¦', rarity: 'N' },
  { id: "shell_n", name: "ã‹ã„ãŒã‚‰", emoji: 'ğŸš', rarity: 'N' },
  { id: "tree_n", name: "ã", emoji: 'ğŸŒ³', rarity: 'N' },
  { id: "flower_n", name: "ã¯ãª", emoji: 'ğŸŒ¸', rarity: 'N' },
  { id: "star_n", name: "ã»ã—", emoji: 'â­', rarity: 'N' },
  { id: "moon_n", name: "ã¤ã", emoji: 'ğŸŒ™', rarity: 'N' },
  { id: "sun_n", name: "ãŸã„ã‚ˆã†", emoji: 'â˜€ï¸', rarity: 'N' },
  { id: "cloud_n", name: "ãã‚‚", emoji: 'â˜ï¸', rarity: 'N' }, // 20

  // R (Rare) - 20ç¨®é¡
  { id: "fox_r", name: "ãã¤ã­", emoji: 'ğŸ¦Š', rarity: 'R' },
  { id: "bear_r", name: "ãã¾", emoji: 'ğŸ»', rarity: 'R' },
  { id: "panda_r", name: "ãƒ‘ãƒ³ãƒ€", emoji: 'ğŸ¼', rarity: 'R' },
  { id: "koala_r", name: "ã‚³ã‚¢ãƒ©", emoji: 'ğŸ¨', rarity: 'R' },
  { id: "tiger_r", name: "ã¨ã‚‰", emoji: 'ğŸ¯', rarity: 'R' },
  { id: "lion_r", name: "ãƒ©ã‚¤ã‚ªãƒ³", emoji: 'ğŸ¦', rarity: 'R' },
  { id: "cow_r", name: "ã†ã—", emoji: 'ğŸ®', rarity: 'R' },
  { id: "monkey_r", name: "ã•ã‚‹", emoji: 'ğŸµ', rarity: 'R' },
  { id: "owl_r", name: "ãµãã‚ã†", emoji: 'ğŸ¦‰', rarity: 'R' },
  { id: "penguin_r", name: "ãƒšãƒ³ã‚®ãƒ³", emoji: 'ğŸ§', rarity: 'R' },
  { id: "squirrel_r", name: "ãƒªã‚¹", emoji: 'ğŸ¿ï¸', rarity: 'R' }, // 11
  { id: "raccoon_r", name: "ã‚¢ãƒ©ã‚¤ã‚°ãƒ", emoji: 'ğŸ¦', rarity: 'R' },
  { id: "skunk_r", name: "ã‚¹ã‚«ãƒ³ã‚¯", emoji: 'ğŸ¦¨', rarity: 'R' },
  { id: "badger_r", name: "ã‚¢ãƒŠã‚°ãƒ", emoji: 'ğŸ¦¡', rarity: 'R' },
  { id: "otter_r", name: "ã‚«ãƒ¯ã‚¦ã‚½", emoji: 'ğŸ¦¦', rarity: 'R' },
  { id: "beaver_r", name: "ãƒ“ãƒ¼ãƒãƒ¼", emoji: 'ğŸ¦«', rarity: 'R' },
  { id: "duck_r", name: "ã‚¢ãƒ’ãƒ«", emoji: 'ğŸ¦†', rarity: 'R' },
  { id: "swan_r", name: "ã¯ãã¡ã‚‡ã†", emoji: 'ğŸ¦¢', rarity: 'R' },
  { id: "rooster_r", name: "ã‚ªãƒ³ãƒ‰ãƒª", emoji: 'ğŸ”', rarity: 'R' },
  { id: "sheep_r", name: "ã²ã¤ã˜", emoji: 'ğŸ‘', rarity: 'R' }, // 20

  // SR (Super Rare) - 20ç¨®é¡
  { id: "wolf_sr", name: "ãŠãŠã‹ã¿", emoji: 'ğŸº', rarity: 'SR' },
  { id: "boar_sr", name: "ã„ã®ã—ã—", emoji: 'ğŸ—', rarity: 'SR' },
  { id: "horse_sr", name: "ã†ã¾", emoji: 'ğŸ´', rarity: 'SR' },
  { id: "zebra_sr", name: "ã—ã¾ã†ã¾", emoji: 'ğŸ¦“', rarity: 'SR' },
  { id: "deer_sr", name: "ã—ã‹", emoji: 'ğŸ¦Œ', rarity: 'SR' },
  { id: "giraffe_sr", name: "ãã‚Šã‚“", emoji: 'ğŸ¦’', rarity: 'SR' },
  { id: "elephant_sr", name: "ãã†", emoji: 'ğŸ˜', rarity: 'SR' },
  { id: "rhino_sr", name: "ã•ã„", emoji: 'ğŸ¦', rarity: 'SR' },
  { id: "hippo_sr", name: "ã‹ã°", emoji: 'ğŸ¦›', rarity: 'SR' },
  { id: "camel_sr", name: "ã‚‰ãã ", emoji: 'ğŸª', rarity: 'SR' },
  { id: "kangaroo_sr", name: "ã‚«ãƒ³ã‚¬ãƒ«ãƒ¼", emoji: 'ğŸ¦˜', rarity: 'SR' }, // 11
  { id: "crocodile_sr", name: "ãƒ¯ãƒ‹", emoji: 'ğŸŠ', rarity: 'SR' },
  { id: "snake_sr", name: "ãƒ˜ãƒ“", emoji: 'ğŸ', rarity: 'SR' },
  { id: "lizard_sr", name: "ãƒˆã‚«ã‚²", emoji: 'ğŸ¦', rarity: 'SR' },
  { id: "turtle_sr", name: "ã‚«ãƒ¡", emoji: 'ğŸ¢', rarity: 'SR' },
  { id: "sloth_sr", name: "ãƒŠãƒã‚±ãƒ¢ãƒ", emoji: 'ğŸ¦¥', rarity: 'SR' },
  { id: "peacock_sr", name: "ã‚¯ã‚¸ãƒ£ã‚¯", emoji: 'ğŸ¦š', rarity: 'SR' },
  { id: "parrot_sr", name: "ã‚ªã‚¦ãƒ ", emoji: 'ğŸ¦œ', rarity: 'SR' },
  { id: "flamingo_sr", name: "ãƒ•ãƒ©ãƒŸãƒ³ã‚´", emoji: 'ğŸ¦©', rarity: 'SR' },
  { id: "badminton_sr", name: "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³", emoji: 'ğŸ¸', rarity: 'SR' }, // 20 (ã‚ªã‚ªãƒã‚·ã®ä»£ã‚ã‚Šã«)

  // SSR (Super Super Rare) - 20ç¨®é¡
  { id: "dolphin_ssr", name: "ã„ã‚‹ã‹", emoji: 'ğŸ¬', rarity: 'SSR' },
  { id: "whale_ssr", name: "ãã˜ã‚‰", emoji: 'ğŸ³', rarity: 'SSR' },
  { id: "shark_ssr", name: "ã•ã‚", emoji: 'ğŸ¦ˆ', rarity: 'SSR' },
  { id: "octopus_ssr", name: "ãŸã“", emoji: 'ğŸ™', rarity: 'SSR' },
  { id: "squid_ssr", name: "ã„ã‹", emoji: 'ğŸ¦‘', rarity: 'SSR' },
  { id: "crab_ssr", name: "ã‹ã«", emoji: 'ğŸ¦€', rarity: 'SSR' },
  { id: "shrimp_ssr", name: "ãˆã³", emoji: 'ğŸ¦', rarity: 'SSR' },
  { id: "eagle_ssr", name: "ã‚ã—", emoji: 'ğŸ¦…', rarity: 'SSR' },
  { id: "bat_ssr", name: "ã“ã†ã‚‚ã‚Š", emoji: 'ğŸ¦‡', rarity: 'SSR' },
  { id: "gorilla_ssr", name: "ã‚´ãƒªãƒ©", emoji: 'ğŸ¦', rarity: 'SSR' },
  { id: "scorpion_ssr", name: "ã‚µã‚½ãƒª", emoji: 'ğŸ¦‚', rarity: 'SSR' }, // 11
  { id: "spider_ssr", name: "ã‚¯ãƒ¢", emoji: 'ğŸ•·ï¸', rarity: 'SSR' },
  { id: "butterfly_ssr", name: "ãƒãƒ§ã‚¦", emoji: 'ğŸ¦‹', rarity: 'SSR' },
  { id: "seal_ssr", name: "ã‚¢ã‚¶ãƒ©ã‚·", emoji: 'ğŸ¦­', rarity: 'SSR' },
  { id: "polar_bear_ssr", name: "ã‚·ãƒ­ã‚¯ãƒ", emoji: 'ğŸ»â€â„ï¸', rarity: 'SSR' },
  { id: "bison_ssr", name: "ãƒã‚¤ã‚½ãƒ³", emoji: 'ğŸƒ', rarity: 'SSR' },
  { id: "mammoth_ssr", name: "ãƒãƒ³ãƒ¢ã‚¹", emoji: 'ğŸ˜', rarity: 'SSR' }, // (ãã†ã¨ã‹ã¶ã‚‹) -> ğŸ¦£
  { id: "dodo_ssr", name: "ãƒ‰ãƒ¼ãƒ‰ãƒ¼", emoji: 'ğŸ¦¤', rarity: 'SSR' },
  { id: "kiwi_ssr", name: "ã‚­ãƒ¼ã‚¦ã‚£", emoji: 'ğŸ¥', rarity: 'SSR' }, // (æœç‰©) -> ğŸ¦
  { id: "mouse_trap_ssr", name: "ã­ãšã¿ã¨ã‚Š", emoji: 'ğŸª¤', rarity: 'SSR' }, // 20
  
  // L (Legendary) - 20ç¨®é¡
  { id: "t_rex_l", name: "ãƒ†ã‚£ãƒ©ãƒã‚µã‚¦ãƒ«ã‚¹", emoji: 'ğŸ¦–', rarity: 'L' },
  { id: "sauropod_l", name: "ãƒ–ãƒ©ã‚­ã‚ªã‚µã‚¦ãƒ«ã‚¹", emoji: 'ğŸ¦•', rarity: 'L' },
  { id: "dragon_l", name: "ãƒ‰ãƒ©ã‚´ãƒ³", emoji: 'ğŸ‰', rarity: 'L' },
  { id: "unicorn_l", name: "ãƒ¦ãƒ‹ã‚³ãƒ¼ãƒ³", emoji: 'ğŸ¦„', rarity: 'L' },
  { id: "comet_l", name: "ã™ã„ã›ã„", emoji: 'â˜„ï¸', rarity: 'L' },
  { id: "alien_l", name: "ã†ã¡ã‚…ã†ã˜ã‚“", emoji: 'ğŸ‘½', rarity: 'L' },
  { id: "robot_l", name: "ãƒ­ãƒœãƒƒãƒˆ", emoji: 'ğŸ¤–', rarity: 'L' },
  { id: "ghost_l", name: "ãŠã°ã‘", emoji: 'ğŸ‘»', rarity: 'L' },
  { id: "volcano_l", name: "ã‹ã–ã‚“", emoji: 'ğŸŒ‹', rarity: 'L' },
  { id: "galaxy_l", name: "ãã‚“ãŒ", emoji: 'ğŸŒŒ', rarity: 'L' },
  { id: "phoenix_l", name: "ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹", emoji: 'ğŸ”¥', rarity: 'L' }, // 11
  { id: "hydra_l", name: "ãƒ’ãƒ‰ãƒ©", emoji: 'ğŸ²', rarity: 'L' },
  { id: "pegasus_l", name: "ãƒšã‚¬ã‚µã‚¹", emoji: 'ğŸ', rarity: 'L' },
  { id: "cerberus_l", name: "ã‚±ãƒ«ãƒ™ãƒ­ã‚¹", emoji: 'ğŸ•', rarity: 'L' },
  { id: "ninja_l", name: "ãƒ‹ãƒ³ã‚¸ãƒ£", emoji: 'ğŸ¥·', rarity: 'L' },
  { id: "samurai_l", name: "ã‚µãƒ ãƒ©ã‚¤", emoji: 'âš”ï¸', rarity: 'L' },
  { id: "ufo_l", name: "UFO", emoji: 'ğŸ›¸', rarity: 'L' },
  { id: "black_hole_l", name: "ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«", emoji: 'âš«', rarity: 'L' },
  { id: "griffin_l", name: "ã‚°ãƒªãƒ•ã‚©ãƒ³", emoji: 'ğŸª½', rarity: 'L' },
  { id: "kraken_l", name: "ã‚¯ãƒ©ãƒ¼ã‚±ãƒ³", emoji: 'ğŸŒŠ', rarity: 'L' }, // 20
];

// ã‚¬ãƒãƒ£ã®é‡ã¿ä»˜ã‘ (åˆè¨ˆ100)
const RARITY_WEIGHTS = {
    'N': 45, // 45%
    'R': 30, // 30%
    'SR': 15, // 15%
    'SSR': 7,  // 7%
    'L': 3   // 3%
};
// ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®ä¸¦ã³é †
const RARITY_LEVELS = { 'N': 1, 'R': 2, 'SR': 3, 'SSR': 4, 'L': 5 };
// (v5.8 ä¿®æ­£1 ã“ã“ã¾ã§)


const initialLessonStats = () => ({ correct: 0, streak: 0, streakMax: 0, titles: [] });

// ===== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ =====
function App() {
  const [lessonId, setLessonId] = useState(LESSONS[0].id);
  const [currentQ, setCurrentQ] = useState(null);
  const [choiceShuffle, setChoiceShuffle] = useState([]);
  const [arrangeChoices, setArrangeChoices] = useState([]);
  const [selectedIndex, setSelectedIndex] = useState(null);
  const [isCorrect, setIsCorrect] = useState(null);
  const [arrPicked, setArrPicked] = useState([]);

  const [coins, setCoins] = useState(0);
  const [coinDelta, setCoinDelta] = useState(0);
  const [dailyStats, setDailyStats] = useState({});
  const [showFuri, setShowFuri] = useState(true);
  const [stats, setStats] = useState({ totalCorrect: 0, globalStreakMax: 0, perLessonStats: {} });
  const [globalStreak, setGlobalStreak] = useState(0);

  const [titlesUnlocked, setTitlesUnlocked] = useState([]);
  const [activeTitle, setActiveTitle] = useState("start");
  
  const [ownedCards, setOwnedCards] = useState(["cat_n"]);
  const [gachaPulls, setGachaPulls] = useState(0);
  const [showGachaResult, setShowGachaResult] = useState(null);
  const [showResetConfirm, setShowResetConfirm] = useState(false);
  const [showTitleInfo, setShowTitleInfo] = useState(false);
  const [showLessonTitleInfo, setShowLessonTitleInfo] = useState(false);
  const [showHint, setShowHint] = useState(false);

  const prevCoinsRef = useRef(0);
  const fileInputRef = useRef(null);
  const recentKeysRef = useRef({});

  const activePerk = useMemo(() => activeTitle ? (TITLE_PERKS[activeTitle] || {}) : {}, [activeTitle]);
  const currentLessonStats = useMemo(() => stats.perLessonStats[lessonId] || initialLessonStats(), [stats, lessonId]);

  // ====== ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ ======
  useEffect(() => {
    try {
      const saved = typeof window !== "undefined" ? localStorage.getItem(LS_KEY) : null;
      if (saved) {
        const d = JSON.parse(saved);
        setCoins(d.coins ?? 0);
        setShowFuri(d.showFuri ?? true);
        setStats(d.stats ?? { totalCorrect: 0, globalStreakMax: 0, perLessonStats: {} });
        setOwnedCards(d.ownedCards ?? ["cat_n"]);
        setGachaPulls(d.gachaPulls ?? 0);
        setTitlesUnlocked(d.titlesUnlocked ?? []);
        setActiveTitle(d.activeTitle ?? "start");
        setDailyStats(d.dailyStats ?? {});
        if (d.lessonId) setLessonId(d.lessonId);
      }
    } catch {}
  }, []);

  useEffect(() => {
    try {
      if (typeof window === "undefined") return;
      localStorage.setItem(LS_KEY, JSON.stringify({ coins, showFuri, stats, ownedCards, gachaPulls, titlesUnlocked, activeTitle, lessonId, dailyStats }));
    } catch {}
  }, [coins, showFuri, stats, ownedCards, gachaPulls, titlesUnlocked, activeTitle, lessonId, dailyStats]);

  // ãƒã‚¤ãƒ³ãƒˆå¢—åŠ ã®æ¼”å‡º
  useEffect(() => {
    const delta = coins - (prevCoinsRef.current || 0);
    if (delta > 0) {
      setCoinDelta(delta);
      setTimeout(() => setCoinDelta(0), 1100);
    }
    prevCoinsRef.current = coins;
  }, [coins]);

  const nextQuestion = useCallback(() => {
    const lesson = LESSONS.find((l) => l.id === lessonId);
    if (!lesson || !lesson.generator) return;

    let q;
    let key;
    let attempts = 0;
    const currentLessonRecentKeys = recentKeysRef.current[lessonId] || [];

    do {
      q = lesson.generator();
      key = q.en ? q.en : (q.tokens ? q.tokens.join(" ") : Math.random().toString());
      attempts++;
    } while (currentLessonRecentKeys.includes(key) && attempts < 12);

    const updatedRecentKeys = [...currentLessonRecentKeys, key];
    if (updatedRecentKeys.length > 10) updatedRecentKeys.shift();
    recentKeysRef.current[lessonId] = updatedRecentKeys;

    setCurrentQ(q);
    setSelectedIndex(null);
    setIsCorrect(null);
    setArrPicked([]);
    setShowHint(false);
    if (q.type === "choice") setChoiceShuffle(ensureFourChoices(q.choices));
    if (q.type === "arrange") setArrangeChoices(shuffle(q.tokens));
  }, [lessonId]);

  useEffect(() => {
    nextQuestion();
  }, [lessonId, nextQuestion]); 

  const onCorrect = useCallback((speakText) => {
    const points = 5;
    const newCoins = coins + points;

    setCoins(newCoins);
    // (v5.1 è¦æœ›: ã‚¬ãƒãƒ£ãƒã‚¤ãƒ³ãƒˆã‚’ 500 -> 200 ã«å¤‰æ›´)
    const oldThreshold = Math.floor(coins / 200);
    const newThreshold = Math.floor(newCoins / 200);
    if (newThreshold > oldThreshold) {
        setGachaPulls(p => p + (newThreshold - oldThreshold));
    }

    const newGlobalStreak = globalStreak + 1;
    setGlobalStreak(newGlobalStreak);
    
    const today = getTodayString();
    setDailyStats(ds => ({ ...ds, [today]: (ds[today] || 0) + points }));

    setStats(st => {
      const lessonStats = st.perLessonStats[lessonId] || initialLessonStats();
      const newLessonStreak = lessonStats.streak + 1;
      const updatedLessonStats = {
          ...lessonStats,
          correct: lessonStats.correct + 1,
          streak: newLessonStreak,
          streakMax: Math.max(lessonStats.streakMax, newLessonStreak),
      };

      const newlyUnlockedLessonTitles = [];
      const currentTitles = updatedLessonStats.titles;
      const potentialTitles = [...currentTitles];

      LESSON_TITLES.forEach(title => {
          if (!potentialTitles.includes(title.id) && title.condition({ ...updatedLessonStats, titles: potentialTitles })) {
              newlyUnlockedLessonTitles.push(title.id);
              potentialTitles.push(title.id);
          }
      });
      
      if (newlyUnlockedLessonTitles.length > 0) {
          updatedLessonStats.titles = potentialTitles;
      }

      const newStats = {
        ...st,
        totalCorrect: st.totalCorrect + 1,
        globalStreakMax: Math.max(st.globalStreakMax, newGlobalStreak),
        perLessonStats: { ...st.perLessonStats, [lessonId]: updatedLessonStats },
      };

      setTitlesUnlocked(t => {
          const newly = [];
          const add = (id) => { if (!t.includes(id) && !newly.includes(id)) newly.push(id); };
          if (newStats.totalCorrect >= 5) add("start");
      // (v6.2 ä¿®æ­£2: ç§°å·ã®ã‚¢ãƒ³ãƒ­ãƒƒã‚¯åˆ¤å®šã‚’æ›´æ–°)
      if (newStats.totalCorrect >= 5) add("start");
      if (newGlobalStreak >= 5) add("streak5");
      if (newCoins >= 1000) add("coin1000");
      if (newCoins >= 5000) add("lionHero");
      if (newCoins >= 10000) add("coin10000");
      if (newCoins >= 20000) add("coin20000");
      if ((newStats.perLessonStats["be-verb"]?.correct ?? 0) >= 5) add("owlGuide");
      const kinds = Object.keys(newStats.perLessonStats).filter((k) => (newStats.perLessonStats[k]?.correct ?? 0) > 0).length;
          if (kinds >= 4) add("explorer");

          const currentHour = new Date().getHours();
          if (currentHour >= 5 && currentHour < 10) {
              add("morningMaster");
          }
          
          return newly.length ? [...t, ...newly] : t;
      });
      
      return newStats;
    });

    speakEn(speakText);
  }, [coins, globalStreak, lessonId]);
  
  const onIncorrect = useCallback(() => {
      setGlobalStreak(0);
      setStats(st => {
          const lessonStats = st.perLessonStats[lessonId] || initialLessonStats();
          return {
              ...st,
              perLessonStats: {
                  ...st.perLessonStats,
                  [lessonId]: { ...lessonStats, streak: 0 }
              }
          };
      });
  }, [lessonId]);

  const handleChoice = useCallback((choice, idx) => {
    if (!currentQ || isCorrect !== null) return;
    setSelectedIndex(idx);
    // (v5.4 ä¿®æ­£1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¯”è¼ƒã§ã¯ãªãã€æ­£è§£ã®æ–‡å­—åˆ—(correctAnswerText)ã¨æ¯”è¼ƒã™ã‚‹)
    const ok = choice === currentQ.correctAnswerText;
    setIsCorrect(ok);
    if (ok) {
        onCorrect(currentQ.speak);
    } else {
        onIncorrect();
        // (v6.2 ä¿®æ­£3: ãƒ–ã‚¶ãƒ¼éŸ³ã‚’å‰Šé™¤)
        // playBuzzer();
        speakEn(currentQ.speak);
    }
  }, [currentQ, isCorrect, onCorrect, onIncorrect]);

  const handleArrangePick = useCallback((token) => {
    if (!currentQ || isCorrect !== null || arrPicked.includes(token)) return;
    const picked = [...arrPicked, token];
    setArrPicked(picked);
    if (picked.length === currentQ.tokens.length) {
      const ok = picked.join(" ") === currentQ.answer.join(" ");
      setIsCorrect(ok);
      if (ok) {
          onCorrect(currentQ.speak);
      } else {
          onIncorrect();
          // (v6.2 ä¿®æ­£3: ãƒ–ã‚¶ãƒ¼éŸ³ã‚’å‰Šé™¤)
          // playBuzzer(); 
          speakEn(currentQ.speak);
      }
    }
  }, [currentQ, isCorrect, arrPicked, onCorrect, onIncorrect]);

  const handleGachaPull = () => {
    if (gachaPulls < 1) return;
    setGachaPulls(p => p - 1);
    
    const availableRarities = Object.keys(RARITY_WEIGHTS);
    
    const weightedPool = [];
    availableRarities.forEach(rarity => {
        for (let i = 0; i < RARITY_WEIGHTS[rarity]; i++) {
            weightedPool.push(rarity);
        }
    });

    const pulledRarity = rand(weightedPool.length > 0 ? weightedPool : ['N']);
    // (v6.2 ä¿®æ­£4: CARDS -> CARDS_V6_2 ã‚’å‚ç…§)
    const possibleCards = CARDS_V6_2.filter(c => c.rarity === pulledRarity);
    const resultCard = rand(possibleCards);

    const isNew = !ownedCards.includes(resultCard.id);
    setShowGachaResult({ ...resultCard, isNew });

    if (isNew) setOwnedCards(c => [...c, resultCard.id]);
  };

  const exportData = () => {
    try {
      const data = { coins, showFuri, stats, ownedCards, gachaPulls, titlesUnlocked, activeTitle, lessonId, dailyStats, ts: Date.now() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const timestamp = new Date().toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '-');
      a.download = `eigo-save-${timestamp}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch {}
  };

  const importData = (e) => {
    const file = e?.target?.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const d = JSON.parse(reader.result);
        setCoins(d.coins ?? 0);
        setShowFuri(d.showFuri ?? true);
        setStats(d.stats ?? { totalCorrect: 0, globalStreakMax: 0, perLessonStats: {} });
        setOwnedCards(d.ownedCards ?? ["cat_n"]);
        setGachaPulls(d.gachaPulls ?? 0);
        setTitlesUnlocked(d.titlesUnlocked ?? []);
        setActiveTitle(d.activeTitle ?? "start");
        setDailyStats(d.dailyStats ?? {});
        if (d.lessonId) setLessonId(d.lessonId);
      } catch {}
    };
    reader.readAsText(file);
  };

  const executeReset = () => {
    setCoins(0);
    setShowFuri(true);
    setStats({ totalCorrect: 0, globalStreakMax: 0, perLessonStats: {} });
    setOwnedCards(["cat_n"]);
    setGachaPulls(0);
    setTitlesUnlocked([]);
    setActiveTitle("start");
    setLessonId(LESSONS[0].id);
    setGlobalStreak(0);
    setDailyStats({});
    setShowResetConfirm(false);
    try { localStorage.removeItem(LS_KEY); } catch {}
  };

  const bgClass = activePerk.theme === "night" ? "from-slate-900 via-indigo-900 to-sky-900 text-white" : "from-indigo-50 via-sky-50 to-white text-gray-900";
  const getTitleEmoji = (id) => (GLOBAL_TITLES.find(t => t.id === id)?.emoji || 'ğŸŒŸ');

  return (
    <div className={`min-h-screen ${bgClass}`}>
      <div className="max-w-6xl mx-auto px-4 py-6">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className={`relative mb-6 overflow-hidden bg-white/80 backdrop-blur transition-all duration-300 rounded-3xl ${activePerk.headerClass || 'border'}`}>
          <div className="absolute inset-0 bg-gradient-to-r from-sky-100/70 via-purple-100/50 to-pink-100/60" />
          <div className="relative p-5 md:p-7 flex flex-col md:flex-row md:items-center md:justify-between gap-4 text-gray-900">
            <div className="flex items-center gap-3">
              <div className="w-9 h-9 flex items-center justify-center text-white rounded-xl text-lg bg-sky-600">{getTitleEmoji(activeTitle)}</div>
              <div>
                <h1 className="text-2xl md:text-3xl font-extrabold tracking-tight"><F rb="å°2" rt="ã—ã‚‡ã†ã«" /><F rb="å‘ã‘" rt="ã‚€ã‘" /> <F rb="è‹±èª" rt="ãˆã„ã”" /> <F rb="æ–‡æ³•" rt="ã¶ã‚“ã½ã†" />ã‚ãã³</h1>
                <div className="text-xs text-gray-600 flex items-center gap-2">
                  {activePerk.headerBadge && <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-amber-100 border text-amber-800">{activePerk.headerBadge}</span>}
                </div>
              </div>
            </div>
            <div className="flex items-center flex-wrap gap-2 md:gap-3">
              <div className="flex items-center gap-2">
                <div className={`relative flex items-center gap-2 text-sm px-3 py-2 rounded-xl bg-white/90 border transition-transform ${coinDelta > 0 ? 'scale-105' : ''}`}>
                  <span>âœ¨ <F rb="åˆè¨ˆ" rt="ã”ã†ã‘ã„" /> Pt</span><span className="font-extrabold tabular-nums">{coins}</span>
                  {coinDelta > 0 && <span className="absolute -top-2 right-1 text-xs text-emerald-700 animate-bounce">+{coinDelta}</span>}
                </div>
                 <div className="flex items-center gap-2 text-sm px-3 py-2 rounded-xl bg-white/90 border">
                  <span>ğŸ—“ï¸ <F rb="ä»Šæ—¥" rt="ãã‚‡ã†" />ã® Pt</span><span className="font-extrabold tabular-nums">{dailyStats[getTodayString()] || 0}</span>
                </div>
              </div>
              <button onClick={() => setShowFuri(s => !s)} className="text-xs px-2 py-1 rounded-lg border bg-white/90">ãµã‚ŠãŒãªï¼š{showFuri ? 'ON' : 'OFF'}</button>
              <div className="relative group">
                <div className="flex items-center gap-1">
                    <button onClick={exportData} className="text-xs px-2 py-1 rounded-l-lg border bg-white/90">ã‚»ãƒ¼ãƒ–</button>
                    <label className="text-xs px-2 py-1 rounded-r-lg border-t border-b border-r bg-white/90 cursor-pointer">ãƒ­ãƒ¼ãƒ‰ <input ref={fileInputRef} type="file" className="hidden" accept=".json" onChange={importData} /></label>
                </div>
                <div className="absolute bottom-full mb-2 w-64 left-1/2 -translate-x-1/2 p-2 text-xs bg-gray-800 text-white rounded-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br/>ä»–ã®PCã¸ãƒ‡ãƒ¼ã‚¿ã‚’ç§»ã™æ™‚ã«ä½¿ã£ã¦ãã ã•ã„ã€‚
                </div>
              </div>
              <button onClick={() => setShowResetConfirm(true)} className="text-xs px-2 py-1 rounded-lg border bg-rose-100 text-rose-700">ãƒªã‚»ãƒƒãƒˆ</button>

            </div>
          </div>
        </div>

        {/* ãƒ¬ãƒƒã‚¹ãƒ³é¸æŠ */}
        <div className="mb-4 flex flex-wrap gap-2">
          {LESSONS.map((l) => (
            <button key={l.id} onClick={() => setLessonId(l.id)}
              className={`px-3 py-1.5 rounded-full border text-sm transition-colors ${lessonId === l.id ? 'bg-sky-600 text-white border-sky-600' : 'bg-white/90 text-gray-800'}`}>
              {showFuri ? l.name : <span>{typeof l.name === 'string' ? l.name : l.id}</span>}
            </button>
          ))}
        </div>

        {/* å‡ºé¡Œã‚«ãƒ¼ãƒ‰ */}
        <div className={`${getLessonCardClass("relative rounded-3xl bg-white/90 p-5 md:p-7 shadow-sm text-gray-900 transition-all duration-300 flex flex-col min-h-[480px]", currentLessonStats.titles)} ${isCorrect === false ? 'bg-rose-50/70' : ''} ${isCorrect === true ? 'animate-flash-correct' : ''}`}>
          <div className="absolute -top-3 -left-3 text-3xl select-none drop-shadow-lg">{getTitleEmoji(activeTitle)}</div>
          {currentQ ? (
            <>
              {/* (v5.1 è¦æœ›3: flex-grow ã‚’è¿½åŠ ) */}
              <div className="flex-grow">
                {currentQ.type === 'choice' && (
                  <>
                    <div className="text-2xl font-semibold mb-2">{currentQ.en.replace('___', 'ï¼¿ï¼¿ï¼¿')}</div>
                <div className="text-lg text-gray-700 mb-4">{showFuri ? currentQ.jp : <span>{currentQ.jp.props.children.map(child => typeof child === 'object' ? child.props.rb : child)}</span>}</div>
                
                {/* (v6.2 ä¿®æ­£5: ã‚¬ãƒãƒ£ã‚µã‚¤ãƒ³) */}
                {gachaPulls > 0 && isCorrect === null && (
                  <div className="my-4 p-3 rounded-lg bg-gradient-to-r from-amber-100 to-yellow-200 border border-amber-300 text-amber-800 font-bold text-center animate-pulse">
                    ğŸ‰ ã‚¬ãƒãƒ£ã‚’ {gachaPulls} å› å¼•ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼ ğŸ‰
                  </div>
                )}
                
                <div className="flex items-center gap-4 text-xs text-gray-600 mb-2">
                  <span>ãƒ¬ãƒƒã‚¹ãƒ³Ptï¼š{currentLessonStats.correct * 5}</span>
                      <span>é€£ç¶šæ­£è§£ï¼š{currentLessonStats.streak} (MAX: {currentLessonStats.streakMax})</span>
                    </div>
                    <div className="flex items-center gap-2 mb-3">
                      <div className="flex items-center gap-1">
                        {LESSON_TITLES.map(t => (
                            <span key={t.id} className={`px-2 py-0.5 rounded-full text-xs border ${currentLessonStats.titles.includes(t.id) ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-500'}`}>{t.emoji} {t.name}</span>
                        ))}
                      </div>
                      <button onClick={() => setShowLessonTitleInfo(true)} className="text-xs w-5 h-5 bg-gray-200 text-gray-600 rounded-full">ï¼Ÿ</button>
                    </div>
                    
                    {activePerk.beHint && (
                      <div className="mb-3">
                        <button onClick={() => setShowHint(s => !s)} className="text-xs px-2 py-1 rounded-lg border bg-emerald-50 text-emerald-800">ãƒ’ãƒ³ãƒˆã‚’{showHint ? 'ã‹ãã™' : 'è¦‹ã‚‹'}</button>
                        {showHint && (
                          <div className="mt-2 text-sm text-emerald-700 p-2 bg-emerald-50 rounded-lg">
                            <h4 className="font-bold">ãƒ’ãƒ³ãƒˆï¼š</h4>
                            <div>{currentQ.explainJP || 'ã“ã® ã‚‚ã‚“ã ã„ ã«ã¯ ãƒ’ãƒ³ãƒˆ ãŒ ã‚ã‚Šã¾ã›ã‚“ã€‚'}</div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                      {choiceShuffle.map((c, i) => {
                          const isSelected = selectedIndex === i;
                          const isTheCorrectAnswer = c === currentQ.correctAnswerText;
                          let btnClass = 'bg-white hover:bg-sky-50';
                          if (isSelected) {
                              btnClass = isCorrect ? 'bg-emerald-100 border-emerald-500' : 'bg-gray-200 border-gray-400 text-gray-500 line-through';
                          } else if (isCorrect === false && isTheCorrectAnswer) {
                              btnClass = 'bg-emerald-100 border-emerald-500';
                          }
                          return (<button key={i} onClick={() => handleChoice(c, i)} disabled={isCorrect !== null} className={`p-3 text-lg rounded-xl border-2 transition-all duration-200 ${btnClass}`}>{c}</button>);
                      })}
                    </div>
                  </>
                )}
                {currentQ.type === 'arrange' && (
                  <>
                    <div className="text-xl font-semibold mb-2">å˜èªã‚’ æ­£ã—ã„é †ã« ä¸¦ã¹ã‚ˆã†</div>
                    <div className="text-lg text-gray-700 mb-4">{showFuri ? currentQ.jp : <span>{currentQ.jp.props.children.map(child => typeof child === 'object' ? child.props.rb : child)}</span>}</div>
                    <div className="flex items-center gap-4 text-xs text-gray-600 mb-2">
                      <span>ãƒ¬ãƒƒã‚¹ãƒ³Ptï¼š{currentLessonStats.correct * 5}</span>
                      <span>é€£ç¶šæ­£è§£ï¼š{currentLessonStats.streak} (MAX: {currentLessonStats.streakMax})</span>
                    </div>
                    <div className="flex items-center gap-1 mb-3">
                      {LESSON_TITLES.map(t => (
                          <span key={t.id} className={`px-2 py-0.5 rounded-full text-xs border ${currentLessonStats.titles.includes(t.id) ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-500'}`}>{t.emoji} {t.name}</span>
                      ))}
                      <button onClick={() => setShowLessonTitleInfo(true)} className="text-xs w-5 h-5 bg-gray-200 text-gray-600 rounded-full">ï¼Ÿ</button>
                    </div>
                    
                    {activePerk.beHint && (
                      <div className="mb-3">
                        <button onClick={() => setShowHint(s => !s)} className="text-xs px-2 py-1 rounded-lg border bg-emerald-50 text-emerald-800">ãƒ’ãƒ³ãƒˆã‚’{showHint ? 'ã‹ãã™' : 'è¦‹ã‚‹'}</button>
                        {showHint && (
                          <div className="mt-2 text-sm text-emerald-700 p-2 bg-emerald-50 rounded-lg">
                            <h4 className="font-bold">ãƒ’ãƒ³ãƒˆï¼š</h4>
                            <div>{currentQ.explainJP || 'ã“ã® ã‚‚ã‚“ã ã„ ã«ã¯ ãƒ’ãƒ³ãƒˆ ãŒ ã‚ã‚Šã¾ã›ã‚“ã€‚'}</div>
                          </div>
                        )}
                      </div>
                    )}
                    
                    <div className="flex flex-wrap gap-2 mb-3">
                      {arrangeChoices.map((t, i) => (<button key={i} onClick={() => handleArrangePick(t)} disabled={arrPicked.includes(t) || isCorrect !== null} className="px-3 py-2 text-lg rounded-xl border bg-white hover:bg-sky-50 disabled:bg-gray-200 disabled:text-gray-400">{t}</button>))}
                    </div>
                    <div className="min-h-[3rem] text-xl tracking-wide p-3 bg-gray-100 rounded-lg border">{arrPicked.join(' ')}</div>
                  </>
                )}
              </div>
              
              {isCorrect !== null && (
                <div className="mt-4 p-3 rounded-lg bg-gray-50 border">
                  {isCorrect ? (<div className="text-emerald-700 font-bold text-lg">ğŸ‰ æ­£è§£ï¼</div>) : (<><div className="text-rose-700 font-bold text-lg">ğŸ˜¢ ãŠã—ã„ï¼</div><div className="mt-2">æ­£è§£ã¯ã€Œ<b className="text-emerald-700">{currentQ.correctAnswerText}</b>ã€ã§ã—ãŸã€‚</div></>)}
                  {currentQ.explainJP && <div className="mt-2"><h4 className="font-bold text-gray-600">ğŸ“ ã‹ãã«ã‚“</h4><div className="text-gray-800">{currentQ.explainJP}</div></div>}
                  
                  {/* (v5.1 è¦æœ›3: ãƒœã‚¿ãƒ³ã‚’ã€Œã‹ãã«ã‚“ã€ãƒ–ãƒ­ãƒƒã‚¯å†…ã«ç§»å‹•ã—ã€å³å¯„ã›ã«ã™ã‚‹) */}
                  <div className="mt-4 text-right"> 
                      <button onClick={nextQuestion} className="px-5 py-3 text-lg rounded-xl bg-sky-600 text-white hover:bg-sky-700 transition-colors">ã¤ãã® ã‚‚ã‚“ã ã„ â†’</button>
                  </div>
                </div>
              )}
            </>
          ) : (<div>èª­ã¿è¾¼ã¿ä¸­â€¦</div>)}
        </div>

        {/* ç§°å·/ã‚«ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
        <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="rounded-2xl border bg-white/90 p-4 text-gray-900">
            <h3 className="font-bold mb-3 text-lg flex items-center gap-2">ğŸ‘‘ <F rt="ãœã‚“ãŸã„ã® ã—ã‚‡ã†ã”ã†" rb="å…¨ä½“ã®ç§°å·" /> <button onClick={() => setShowTitleInfo(true)} className="text-xs w-5 h-5 bg-gray-200 text-gray-600 rounded-full">ï¼Ÿ</button></h3>
            <div className="flex flex-wrap gap-2">
              {GLOBAL_TITLES.map(t => (<button key={t.id} onClick={() => setActiveTitle(t.id)} disabled={!titlesUnlocked.includes(t.id)} className={`px-3 py-1.5 rounded-full border text-sm transition-all ${activeTitle === t.id ? 'bg-amber-400 border-amber-500 text-white font-bold' : 'bg-white disabled:bg-gray-200 disabled:text-gray-400'}`}>{t.emoji} {t.name}</button>))}
            </div>
          </div>
          <div className="rounded-2xl border bg-white/90 p-4 text-gray-900">
            <div className="flex justify-between items-center mb-3">
                <h3 className="font-bold text-lg">ğŸ´ <F rt="ãã‚ƒã‚‰" rb="ã‚­ãƒ£ãƒ©" /><F rt="ã‹ãƒ¼ã©" rb="ã‚«ãƒ¼ãƒ‰" /></h3>
                <button onClick={handleGachaPull} disabled={gachaPulls < 1} className="px-4 py-2 rounded-lg bg-gradient-to-r from-amber-400 to-yellow-500 text-white font-bold shadow-lg disabled:from-gray-300 disabled:to-gray-400 disabled:shadow-none transition-all hover:scale-105">ã‚¬ãƒãƒ£ã‚’å¼•ã ({gachaPulls}å›)</button>
            </div>
            <div className="flex flex-wrap gap-4">
              {/* (v6.2 ä¿®æ­£4: CARDS -> CARDS_V6_2 ã‚’å‚ç…§) */}
              {CARDS_V6_2.filter(c => ownedCards.includes(c.id)).sort((a, b) => RARITY_LEVELS[a.rarity] - RARITY_LEVELS[b.rarity]).map(c => {
                const rarityColors = { N: 'bg-gray-500', R: 'bg-yellow-500', SR: 'bg-purple-600', SSR: 'bg-red-600', L: 'bg-gradient-to-r from-cyan-400 to-blue-500' };
                const borderColors = { N: 'border-gray-300', R: 'border-amber-400', SR: 'border-indigo-400', SSR: 'border-red-400', L: 'border-blue-400' };
                const bgColors = { N: 'bg-gray-100', R: 'bg-yellow-100/70', SR: 'bg-indigo-100/70', SSR: 'bg-red-100/70', L: 'bg-cyan-100/70' };
                
                return (
                    <div key={c.id} className={`relative flex flex-col items-center gap-2 px-4 py-3 rounded-2xl border-2 shadow-lg transition-transform hover:scale-105 ${borderColors[c.rarity]} ${bgColors[c.rarity]}`}>
                      <span className={`absolute -top-3 -right-3 px-2.5 py-1 text-xs font-bold text-white rounded-full shadow-md ${rarityColors[c.rarity]}`}>{c.rarity}</span>
                      <span className="text-5xl drop-shadow-md">{c.emoji}</span>
                      <span className="font-bold text-gray-800">{c.name}</span>
                    </div>
                );
              })}
            </div>
          </div>
        </div>
      </div>
      
      {/* ãƒ¢ãƒ¼ãƒ€ãƒ« */}
      {showResetConfirm && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl p-8 shadow-2xl max-w-sm w-full text-gray-900">
                <h3 className="text-xl font-bold mb-4">ã»ã‚“ã¨ã†ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3>
                <p className="text-gray-600 mb-6">ã™ã¹ã¦ã®ãƒã‚¤ãƒ³ãƒˆã€ãƒ¬ãƒƒã‚¹ãƒ³è¨˜éŒ²ã€ç§°å·ãŒæ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
                <div className="flex justify-end gap-4">
                    <button onClick={() => setShowResetConfirm(false)} className="px-4 py-2 rounded-lg border">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onClick={executeReset} className="px-4 py-2 rounded-lg bg-rose-600 text-white">ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
                </div>
            </div>
        </div>
      )}
      {showGachaResult && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onClick={() => setShowGachaResult(null)}>
            <div className="bg-white rounded-2xl p-8 shadow-2xl text-center animate-jump-in text-gray-900" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-lg font-bold mb-2">{showGachaResult.isNew ? "âœ¨æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’ã‚²ãƒƒãƒˆï¼âœ¨" : "ã‚«ãƒ¼ãƒ‰ã‚’ã‚²ãƒƒãƒˆï¼"}</h3>
                <div className={`inline-flex flex-col items-center gap-2 px-8 py-6 my-4 rounded-2xl border-4 shadow-lg ${
                    showGachaResult.rarity === 'L' ? 'border-blue-400 bg-cyan-50' :
                    showGachaResult.rarity === 'SSR' ? 'border-red-400 bg-red-50' : 
                    showGachaResult.rarity === 'SR' ? 'border-indigo-400 bg-indigo-50' : 
                    showGachaResult.rarity === 'R' ? 'border-amber-400 bg-amber-50' : 
                    'border-gray-300 bg-gray-50'
                }`}>
                    <span className="text-7xl drop-shadow-lg">{showGachaResult.emoji}</span>
                    <span className="text-2xl font-bold text-gray-800">{showGachaResult.name}</span>
                    <span className="text-lg font-bold text-gray-600">ãƒ¬ã‚¢åº¦: {showGachaResult.rarity}</span>
                </div>
                <button onClick={() => setShowGachaResult(null)} className="px-5 py-2 rounded-lg bg-sky-600 text-white">ã¨ã˜ã‚‹</button>

            </div>
        </div>
      )}
      {showTitleInfo && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowTitleInfo(false)}>
            <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-md w-full text-gray-900" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-xl font-bold mb-4">ğŸ‘‘ å…¨ä½“ã®ç§°å·ã®ã¨ã‚Šã‹ãŸ</h3>
                <ul className="space-y-2">
                    {GLOBAL_TITLES.map(t => (
                        <li key={t.id} className="flex items-start gap-3">
                            <span className="text-2xl">{t.emoji}</span>
                            <div>
                                <span className="font-bold">{t.name}</span>
                                <p className="text-sm text-gray-600">{t.desc}</p>
                            </div>
                        </li>
                    ))}
                </ul>
                <div className="text-right mt-5">
                    <button onClick={() => setShowTitleInfo(false)} className="px-5 py-2 rounded-lg bg-sky-600 text-white">ã¨ã˜ã‚‹</button>
                </div>
            </div>
        </div>
      )}
      {showLessonTitleInfo && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowLessonTitleInfo(false)}>
            <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-md w-full text-gray-900" onClick={(e) => e.stopPropagation()}>
                <h3 className="text-xl font-bold mb-4">ğŸ… ãƒ¬ãƒƒã‚¹ãƒ³ç§°å·ã®ã¨ã‚Šã‹ãŸ</h3>
                <ul className="space-y-2">
                    {LESSON_TITLES.map(t => (
                        <li key={t.id} className="flex items-start gap-3">
                            <span className="text-2xl">{t.emoji}</span>
                            <div>
                                <span className="font-bold">{t.name}</span>
                                <p className="text-sm text-gray-600">{t.desc}</p>
                            </div>
                        </li>
                    ))}
                </ul>
                <div className="text-right mt-5">
                    <button onClick={() => setShowLessonTitleInfo(false)} className="px-5 py-2 rounded-lg bg-sky-600 text-white">ã¨ã˜ã‚‹</button>
                </div>
            </div>
        </div>
      )}
    </div>
  );
}

// 6. Reactã‚¢ãƒ—ãƒªã‚’ãƒã‚¦ãƒ³ãƒˆï¼ˆèµ·å‹•ï¼‰
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

    </script>
</body>
</html>
